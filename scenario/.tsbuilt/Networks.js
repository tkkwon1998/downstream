"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.storeAndSaveContract = exports.loadContractData = exports.loadContracts = exports.mergeContractABI = exports.saveContract = exports.storeContract = exports.parseNetworkFile = void 0;
const immutable_1 = require("immutable");
const Contract_1 = require("./Contract");
const File_1 = require("./File");
function parseNetworkFile(data) {
    return immutable_1.fromJS(typeof data === 'string' ? JSON.parse(data) : data);
}
exports.parseNetworkFile = parseNetworkFile;
function serializeNetworkFile(networks) {
    return JSON.stringify(networks.toJSON(), null, 4);
}
function readNetworkFile(world, isABI) {
    return File_1.readFile(world, File_1.getNetworkPath(world.basePath, world.network, isABI ? '-abi' : ''), immutable_1.Map({}), parseNetworkFile);
}
function writeNetworkFile(world, networks, isABI) {
    return File_1.writeFile(world, File_1.getNetworkPath(world.basePath, world.network, isABI ? '-abi' : ''), serializeNetworkFile(networks));
}
function storeContract(world, contract, name, extraData) {
    contract = Contract_1.setContractName(name, contract);
    world = world.set('lastContract', contract);
    world = world.setIn(['contractIndex', contract._address.toLowerCase()], contract);
    world = updateEventDecoder(world, contract);
    world = world.update('contractData', contractData => {
        return extraData.reduce((acc, { index, data }) => {
            if (typeof data !== 'string' && typeof data !== 'number') {
                // Store extra data as an immutable
                data = immutable_1.Map(data);
            }
            return acc.setIn(index, data);
        }, contractData);
    });
    return world;
}
exports.storeContract = storeContract;
async function saveContract(world, contract, name, extraData) {
    let networks = await readNetworkFile(world, false);
    let networksABI = await readNetworkFile(world, true);
    networks = extraData.reduce((acc, { index, data }) => acc.setIn(index, data), networks);
    networksABI = networksABI.set(name, contract._jsonInterface);
    // Don't write during a dry-run
    if (!world.dryRun) {
        world = await writeNetworkFile(world, networks, false);
        world = await writeNetworkFile(world, networksABI, true);
    }
    return world;
}
exports.saveContract = saveContract;
// Merges a contract into another, which is important for delegation
async function mergeContractABI(world, targetName, contractTarget, a, b) {
    let networks = await readNetworkFile(world, false);
    let networksABI = await readNetworkFile(world, true);
    let aABI = networksABI.get(a);
    let bABI = networksABI.get(b);
    if (!aABI) {
        throw new Error(`Missing contract ABI for ${a}`);
    }
    if (!bABI) {
        throw new Error(`Missing contract ABI for ${b}`);
    }
    const itemBySig = {};
    for (let item of aABI.toJS().concat(bABI.toJS())) {
        itemBySig[item.signature] = item;
    }
    const fullABI = Object.values(itemBySig);
    // Store Comptroller address
    networks = networks.setIn(['Contracts', targetName], contractTarget._address);
    world = world.setIn(['contractData', 'Contracts', targetName], contractTarget._address);
    networksABI = networksABI.set(targetName, fullABI);
    let mergedContract = new world.web3.eth.Contract(fullABI, contractTarget._address, {});
    /// XXXS
    world = world.setIn(['contractIndex', contractTarget._address.toLowerCase()], Contract_1.setContractName(targetName, mergedContract));
    // Don't write during a dry-run
    if (!world.dryRun) {
        world = await writeNetworkFile(world, networks, false);
        world = await writeNetworkFile(world, networksABI, true);
    }
    return world;
}
exports.mergeContractABI = mergeContractABI;
async function loadContracts(world) {
    let networks = await readNetworkFile(world, false);
    let networksABI = await readNetworkFile(world, true);
    return loadContractData(world, networks, networksABI);
}
exports.loadContracts = loadContracts;
function updateEventDecoder(world, contract) {
    const updatedEventDecoder = contract._jsonInterface
        .filter(i => i.type == 'event')
        .reduce((accum, event) => {
        const { anonymous, inputs, signature } = event;
        return {
            ...accum,
            [signature]: log => {
                let argTopics = anonymous ? log.topics : log.topics.slice(1);
                return world.web3.eth.abi.decodeLog(inputs, log.data, argTopics);
            }
        };
    }, world.eventDecoder);
    return world.set('eventDecoder', updatedEventDecoder);
}
async function loadContractData(world, networks, networksABI) {
    // Pull off contracts value and the rest is "extra"
    let contractInfo = [];
    let contracts = networks.get('Contracts') || immutable_1.Map({});
    world = contracts.reduce((world, address, name) => {
        let abi = networksABI.has(name) ? networksABI.get(name).toJS() : [];
        let contract = new world.web3.eth.Contract(abi, address, {});
        world = updateEventDecoder(world, contract);
        contractInfo.push(`${name}: ${address}`);
        // Store the contract
        // XXXS
        return world.setIn(['contractIndex', contract._address.toLowerCase()], Contract_1.setContractName(name, contract));
    }, world);
    world = world.update('contractData', contractData => contractData.mergeDeep(networks));
    return [world, contractInfo];
}
exports.loadContractData = loadContractData;
async function storeAndSaveContract(world, contract, name, invokation, extraData) {
    extraData.push({ index: ['Contracts', name], data: contract._address });
    if (contract.constructorAbi) {
        extraData.push({ index: ['Constructors', name], data: contract.constructorAbi });
    }
    if (invokation && invokation.receipt) {
        extraData.push({ index: ['Blocks', name], data: invokation.receipt.blockNumber });
    }
    world = storeContract(world, contract, name, extraData);
    world = await saveContract(world, contract, name, extraData);
    return world;
}
exports.storeAndSaveContract = storeAndSaveContract;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTmV0d29ya3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvTmV0d29ya3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEseUNBQXdDO0FBR3hDLHlDQUF1RDtBQUN2RCxpQ0FBNkQ7QUFVN0QsU0FBZ0IsZ0JBQWdCLENBQUMsSUFBcUI7SUFDcEQsT0FBTyxrQkFBTSxDQUFDLE9BQU8sSUFBSSxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDcEUsQ0FBQztBQUZELDRDQUVDO0FBRUQsU0FBUyxvQkFBb0IsQ0FBQyxRQUFrQjtJQUM5QyxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztBQUNwRCxDQUFDO0FBRUQsU0FBUyxlQUFlLENBQUMsS0FBWSxFQUFFLEtBQWM7SUFDbkQsT0FBTyxlQUFRLENBQ2IsS0FBSyxFQUNMLHFCQUFjLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFDbEUsZUFBRyxDQUFDLEVBQUUsQ0FBQyxFQUNQLGdCQUFnQixDQUNqQixDQUFDO0FBQ0osQ0FBQztBQUVELFNBQVMsZ0JBQWdCLENBQUMsS0FBWSxFQUFFLFFBQWtCLEVBQUUsS0FBYztJQUN4RSxPQUFPLGdCQUFTLENBQ2QsS0FBSyxFQUNMLHFCQUFjLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFDbEUsb0JBQW9CLENBQUMsUUFBUSxDQUFDLENBQy9CLENBQUM7QUFDSixDQUFDO0FBRUQsU0FBZ0IsYUFBYSxDQUFDLEtBQVksRUFBRSxRQUFrQixFQUFFLElBQVksRUFBRSxTQUFzQjtJQUNsRyxRQUFRLEdBQUcsMEJBQWUsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFFM0MsS0FBSyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsY0FBYyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQzVDLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsZUFBZSxFQUFFLFFBQVEsQ0FBQyxRQUFRLENBQUMsV0FBVyxFQUFFLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUNsRixLQUFLLEdBQUcsa0JBQWtCLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBRTVDLEtBQUssR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLGNBQWMsRUFBRSxZQUFZLENBQUMsRUFBRTtRQUNsRCxPQUFPLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRTtZQUMvQyxJQUFJLE9BQU8sSUFBSSxLQUFLLFFBQVEsSUFBSSxPQUFPLElBQUksS0FBSyxRQUFRLEVBQUU7Z0JBQ3hELG1DQUFtQztnQkFDbkMsSUFBSSxHQUFHLGVBQUcsQ0FBTSxJQUFJLENBQUMsQ0FBQzthQUN2QjtZQUVELE9BQU8sR0FBRyxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDaEMsQ0FBQyxFQUFFLFlBQVksQ0FBQyxDQUFDO0lBQ25CLENBQUMsQ0FBQyxDQUFDO0lBRUgsT0FBTyxLQUFLLENBQUM7QUFDZixDQUFDO0FBbkJELHNDQW1CQztBQUVNLEtBQUssVUFBVSxZQUFZLENBQ2hDLEtBQVksRUFDWixRQUFrQixFQUNsQixJQUFZLEVBQ1osU0FBc0I7SUFFdEIsSUFBSSxRQUFRLEdBQUcsTUFBTSxlQUFlLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ25ELElBQUksV0FBVyxHQUFHLE1BQU0sZUFBZSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztJQUVyRCxRQUFRLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDeEYsV0FBVyxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUU3RCwrQkFBK0I7SUFDL0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUU7UUFDakIsS0FBSyxHQUFHLE1BQU0sZ0JBQWdCLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN2RCxLQUFLLEdBQUcsTUFBTSxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsV0FBVyxFQUFFLElBQUksQ0FBQyxDQUFDO0tBQzFEO0lBRUQsT0FBTyxLQUFLLENBQUM7QUFDZixDQUFDO0FBbkJELG9DQW1CQztBQUVELG9FQUFvRTtBQUM3RCxLQUFLLFVBQVUsZ0JBQWdCLENBQ3BDLEtBQVksRUFDWixVQUFrQixFQUNsQixjQUF3QixFQUN4QixDQUFTLEVBQ1QsQ0FBUztJQUVULElBQUksUUFBUSxHQUFHLE1BQU0sZUFBZSxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNuRCxJQUFJLFdBQVcsR0FBRyxNQUFNLGVBQWUsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDckQsSUFBSSxJQUFJLEdBQUcsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUM5QixJQUFJLElBQUksR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTlCLElBQUksQ0FBQyxJQUFJLEVBQUU7UUFDVCxNQUFNLElBQUksS0FBSyxDQUFDLDRCQUE0QixDQUFDLEVBQUUsQ0FBQyxDQUFDO0tBQ2xEO0lBRUQsSUFBSSxDQUFDLElBQUksRUFBRTtRQUNULE1BQU0sSUFBSSxLQUFLLENBQUMsNEJBQTRCLENBQUMsRUFBRSxDQUFDLENBQUM7S0FDbEQ7SUFFRCxNQUFNLFNBQVMsR0FBK0IsRUFBRSxDQUFDO0lBQ2pELEtBQUssSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRTtRQUNoRCxTQUFTLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLElBQUksQ0FBQztLQUNsQztJQUNELE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7SUFFekMsNEJBQTRCO0lBQzVCLFFBQVEsR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsV0FBVyxFQUFFLFVBQVUsQ0FBQyxFQUFFLGNBQWMsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUM5RSxLQUFLLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLGNBQWMsRUFBRSxXQUFXLEVBQUUsVUFBVSxDQUFDLEVBQUUsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBRXhGLFdBQVcsR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUVuRCxJQUFJLGNBQWMsR0FBRyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxPQUFPLEVBQUUsY0FBYyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUV2RixRQUFRO0lBQ1IsS0FBSyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQ2pCLENBQUMsZUFBZSxFQUFFLGNBQWMsQ0FBQyxRQUFRLENBQUMsV0FBVyxFQUFFLENBQUMsRUFDeEQsMEJBQWUsQ0FBQyxVQUFVLEVBQXFCLGNBQWMsQ0FBQyxDQUMvRCxDQUFDO0lBRUYsK0JBQStCO0lBQy9CLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFO1FBQ2pCLEtBQUssR0FBRyxNQUFNLGdCQUFnQixDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDdkQsS0FBSyxHQUFHLE1BQU0sZ0JBQWdCLENBQUMsS0FBSyxFQUFFLFdBQVcsRUFBRSxJQUFJLENBQUMsQ0FBQztLQUMxRDtJQUVELE9BQU8sS0FBSyxDQUFDO0FBQ2YsQ0FBQztBQS9DRCw0Q0ErQ0M7QUFFTSxLQUFLLFVBQVUsYUFBYSxDQUFDLEtBQVk7SUFDOUMsSUFBSSxRQUFRLEdBQUcsTUFBTSxlQUFlLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ25ELElBQUksV0FBVyxHQUFHLE1BQU0sZUFBZSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztJQUVyRCxPQUFPLGdCQUFnQixDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsV0FBVyxDQUFDLENBQUM7QUFDeEQsQ0FBQztBQUxELHNDQUtDO0FBRUQsU0FBUyxrQkFBa0IsQ0FBQyxLQUFZLEVBQUUsUUFBYTtJQUNyRCxNQUFNLG1CQUFtQixHQUFHLFFBQVEsQ0FBQyxjQUFjO1NBQ2hELE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksT0FBTyxDQUFDO1NBQzlCLE1BQU0sQ0FBQyxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsRUFBRTtRQUN2QixNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsR0FBRyxLQUFLLENBQUM7UUFDL0MsT0FBTztZQUNMLEdBQUcsS0FBSztZQUNSLENBQUMsU0FBUyxDQUFDLEVBQUUsR0FBRyxDQUFDLEVBQUU7Z0JBQ2pCLElBQUksU0FBUyxHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzdELE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsQ0FBQztZQUNuRSxDQUFDO1NBQ0YsQ0FBQztJQUNKLENBQUMsRUFBRSxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUM7SUFFekIsT0FBTyxLQUFLLENBQUMsR0FBRyxDQUFDLGNBQWMsRUFBRSxtQkFBbUIsQ0FBQyxDQUFBO0FBQ3ZELENBQUM7QUFFTSxLQUFLLFVBQVUsZ0JBQWdCLENBQ3BDLEtBQVksRUFDWixRQUFrQixFQUNsQixXQUFxQjtJQUVyQixtREFBbUQ7SUFDbkQsSUFBSSxZQUFZLEdBQWEsRUFBRSxDQUFDO0lBQ2hDLElBQUksU0FBUyxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLElBQUksZUFBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBRXJELEtBQUssR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBWSxFQUFFLE9BQWUsRUFBRSxJQUFZLEVBQUUsRUFBRTtRQUN2RSxJQUFJLEdBQUcsR0FBYyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDL0UsSUFBSSxRQUFRLEdBQUcsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUFFLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQztRQUU3RCxLQUFLLEdBQUcsa0JBQWtCLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBRTVDLFlBQVksQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLEtBQUssT0FBTyxFQUFFLENBQUMsQ0FBQztRQUV6QyxxQkFBcUI7UUFDckIsT0FBTztRQUNQLE9BQU8sS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLGVBQWUsRUFBUSxRQUFTLENBQUMsUUFBUSxDQUFDLFdBQVcsRUFBRSxDQUFDLEVBQUUsMEJBQWUsQ0FBQyxJQUFJLEVBQXFCLFFBQVEsQ0FBQyxDQUFDLENBQUM7SUFDcEksQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBRVYsS0FBSyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsY0FBYyxFQUFFLFlBQVksQ0FBQyxFQUFFLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO0lBRXZGLE9BQU8sQ0FBQyxLQUFLLEVBQUUsWUFBWSxDQUFDLENBQUM7QUFDL0IsQ0FBQztBQXpCRCw0Q0F5QkM7QUFFTSxLQUFLLFVBQVUsb0JBQW9CLENBQ3hDLEtBQVksRUFDWixRQUFrQixFQUNsQixJQUFZLEVBQ1osVUFBZ0MsRUFDaEMsU0FBc0I7SUFFdEIsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7SUFDeEUsSUFBSSxRQUFRLENBQUMsY0FBYyxFQUFFO1FBQzNCLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFDO0tBQ2xGO0lBQ0QsSUFBSSxVQUFVLElBQUksVUFBVSxDQUFDLE9BQU8sRUFBRTtRQUNwQyxTQUFTLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxFQUFFLElBQUksRUFBRSxVQUFVLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7S0FDbkY7SUFFRCxLQUFLLEdBQUcsYUFBYSxDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQ3hELEtBQUssR0FBRyxNQUFNLFlBQVksQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxTQUFTLENBQUMsQ0FBQztJQUU3RCxPQUFPLEtBQUssQ0FBQztBQUNmLENBQUM7QUFuQkQsb0RBbUJDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZnJvbUpTLCBNYXAgfSBmcm9tICdpbW11dGFibGUnO1xuaW1wb3J0IHsgV29ybGQgfSBmcm9tICcuL1dvcmxkJztcbmltcG9ydCB7IEludm9rYXRpb24gfSBmcm9tICcuL0ludm9rYXRpb24nO1xuaW1wb3J0IHsgQ29udHJhY3QsIHNldENvbnRyYWN0TmFtZSB9IGZyb20gJy4vQ29udHJhY3QnO1xuaW1wb3J0IHsgZ2V0TmV0d29ya1BhdGgsIHJlYWRGaWxlLCB3cml0ZUZpbGUgfSBmcm9tICcuL0ZpbGUnO1xuaW1wb3J0IHsgQWJpSXRlbSB9IGZyb20gJ3dlYjMtdXRpbHMnO1xuXG50eXBlIE5ldHdvcmtzID0gTWFwPHN0cmluZywgYW55PjtcblxuaW50ZXJmYWNlIEV4dHJhRGF0YSB7XG4gIGluZGV4OiBzdHJpbmdbXTtcbiAgZGF0YTogb2JqZWN0IHwgc3RyaW5nIHwgbnVtYmVyO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VOZXR3b3JrRmlsZShkYXRhOiBzdHJpbmcgfCBvYmplY3QpOiBOZXR3b3JrcyB7XG4gIHJldHVybiBmcm9tSlModHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnID8gSlNPTi5wYXJzZShkYXRhKSA6IGRhdGEpO1xufVxuXG5mdW5jdGlvbiBzZXJpYWxpemVOZXR3b3JrRmlsZShuZXR3b3JrczogTmV0d29ya3MpOiBzdHJpbmcge1xuICByZXR1cm4gSlNPTi5zdHJpbmdpZnkobmV0d29ya3MudG9KU09OKCksIG51bGwsIDQpO1xufVxuXG5mdW5jdGlvbiByZWFkTmV0d29ya0ZpbGUod29ybGQ6IFdvcmxkLCBpc0FCSTogYm9vbGVhbik6IFByb21pc2U8TmV0d29ya3M+IHtcbiAgcmV0dXJuIHJlYWRGaWxlKFxuICAgIHdvcmxkLFxuICAgIGdldE5ldHdvcmtQYXRoKHdvcmxkLmJhc2VQYXRoLCB3b3JsZC5uZXR3b3JrLCBpc0FCSSA/ICctYWJpJyA6ICcnKSxcbiAgICBNYXAoe30pLFxuICAgIHBhcnNlTmV0d29ya0ZpbGVcbiAgKTtcbn1cblxuZnVuY3Rpb24gd3JpdGVOZXR3b3JrRmlsZSh3b3JsZDogV29ybGQsIG5ldHdvcmtzOiBOZXR3b3JrcywgaXNBQkk6IGJvb2xlYW4pOiBQcm9taXNlPFdvcmxkPiB7XG4gIHJldHVybiB3cml0ZUZpbGUoXG4gICAgd29ybGQsXG4gICAgZ2V0TmV0d29ya1BhdGgod29ybGQuYmFzZVBhdGgsIHdvcmxkLm5ldHdvcmssIGlzQUJJID8gJy1hYmknIDogJycpLFxuICAgIHNlcmlhbGl6ZU5ldHdvcmtGaWxlKG5ldHdvcmtzKVxuICApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc3RvcmVDb250cmFjdCh3b3JsZDogV29ybGQsIGNvbnRyYWN0OiBDb250cmFjdCwgbmFtZTogc3RyaW5nLCBleHRyYURhdGE6IEV4dHJhRGF0YVtdKTogV29ybGQge1xuICBjb250cmFjdCA9IHNldENvbnRyYWN0TmFtZShuYW1lLCBjb250cmFjdCk7XG5cbiAgd29ybGQgPSB3b3JsZC5zZXQoJ2xhc3RDb250cmFjdCcsIGNvbnRyYWN0KTtcbiAgd29ybGQgPSB3b3JsZC5zZXRJbihbJ2NvbnRyYWN0SW5kZXgnLCBjb250cmFjdC5fYWRkcmVzcy50b0xvd2VyQ2FzZSgpXSwgY29udHJhY3QpO1xuICB3b3JsZCA9IHVwZGF0ZUV2ZW50RGVjb2Rlcih3b3JsZCwgY29udHJhY3QpO1xuXG4gIHdvcmxkID0gd29ybGQudXBkYXRlKCdjb250cmFjdERhdGEnLCBjb250cmFjdERhdGEgPT4ge1xuICAgIHJldHVybiBleHRyYURhdGEucmVkdWNlKChhY2MsIHsgaW5kZXgsIGRhdGEgfSkgPT4ge1xuICAgICAgaWYgKHR5cGVvZiBkYXRhICE9PSAnc3RyaW5nJyAmJiB0eXBlb2YgZGF0YSAhPT0gJ251bWJlcicpIHtcbiAgICAgICAgLy8gU3RvcmUgZXh0cmEgZGF0YSBhcyBhbiBpbW11dGFibGVcbiAgICAgICAgZGF0YSA9IE1hcCg8YW55PmRhdGEpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gYWNjLnNldEluKGluZGV4LCBkYXRhKTtcbiAgICB9LCBjb250cmFjdERhdGEpO1xuICB9KTtcblxuICByZXR1cm4gd29ybGQ7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzYXZlQ29udHJhY3Q8VD4oXG4gIHdvcmxkOiBXb3JsZCxcbiAgY29udHJhY3Q6IENvbnRyYWN0LFxuICBuYW1lOiBzdHJpbmcsXG4gIGV4dHJhRGF0YTogRXh0cmFEYXRhW11cbik6IFByb21pc2U8V29ybGQ+IHtcbiAgbGV0IG5ldHdvcmtzID0gYXdhaXQgcmVhZE5ldHdvcmtGaWxlKHdvcmxkLCBmYWxzZSk7XG4gIGxldCBuZXR3b3Jrc0FCSSA9IGF3YWl0IHJlYWROZXR3b3JrRmlsZSh3b3JsZCwgdHJ1ZSk7XG5cbiAgbmV0d29ya3MgPSBleHRyYURhdGEucmVkdWNlKChhY2MsIHsgaW5kZXgsIGRhdGEgfSkgPT4gYWNjLnNldEluKGluZGV4LCBkYXRhKSwgbmV0d29ya3MpO1xuICBuZXR3b3Jrc0FCSSA9IG5ldHdvcmtzQUJJLnNldChuYW1lLCBjb250cmFjdC5fanNvbkludGVyZmFjZSk7XG5cbiAgLy8gRG9uJ3Qgd3JpdGUgZHVyaW5nIGEgZHJ5LXJ1blxuICBpZiAoIXdvcmxkLmRyeVJ1bikge1xuICAgIHdvcmxkID0gYXdhaXQgd3JpdGVOZXR3b3JrRmlsZSh3b3JsZCwgbmV0d29ya3MsIGZhbHNlKTtcbiAgICB3b3JsZCA9IGF3YWl0IHdyaXRlTmV0d29ya0ZpbGUod29ybGQsIG5ldHdvcmtzQUJJLCB0cnVlKTtcbiAgfVxuXG4gIHJldHVybiB3b3JsZDtcbn1cblxuLy8gTWVyZ2VzIGEgY29udHJhY3QgaW50byBhbm90aGVyLCB3aGljaCBpcyBpbXBvcnRhbnQgZm9yIGRlbGVnYXRpb25cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBtZXJnZUNvbnRyYWN0QUJJKFxuICB3b3JsZDogV29ybGQsXG4gIHRhcmdldE5hbWU6IHN0cmluZyxcbiAgY29udHJhY3RUYXJnZXQ6IENvbnRyYWN0LFxuICBhOiBzdHJpbmcsXG4gIGI6IHN0cmluZ1xuKTogUHJvbWlzZTxXb3JsZD4ge1xuICBsZXQgbmV0d29ya3MgPSBhd2FpdCByZWFkTmV0d29ya0ZpbGUod29ybGQsIGZhbHNlKTtcbiAgbGV0IG5ldHdvcmtzQUJJID0gYXdhaXQgcmVhZE5ldHdvcmtGaWxlKHdvcmxkLCB0cnVlKTtcbiAgbGV0IGFBQkkgPSBuZXR3b3Jrc0FCSS5nZXQoYSk7XG4gIGxldCBiQUJJID0gbmV0d29ya3NBQkkuZ2V0KGIpO1xuXG4gIGlmICghYUFCSSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgTWlzc2luZyBjb250cmFjdCBBQkkgZm9yICR7YX1gKTtcbiAgfVxuXG4gIGlmICghYkFCSSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgTWlzc2luZyBjb250cmFjdCBBQkkgZm9yICR7Yn1gKTtcbiAgfVxuXG4gIGNvbnN0IGl0ZW1CeVNpZzogeyBba2V5OiBzdHJpbmddOiBBYmlJdGVtIH0gPSB7fTtcbiAgZm9yIChsZXQgaXRlbSBvZiBhQUJJLnRvSlMoKS5jb25jYXQoYkFCSS50b0pTKCkpKSB7XG4gICAgaXRlbUJ5U2lnW2l0ZW0uc2lnbmF0dXJlXSA9IGl0ZW07XG4gIH1cbiAgY29uc3QgZnVsbEFCSSA9IE9iamVjdC52YWx1ZXMoaXRlbUJ5U2lnKTtcblxuICAvLyBTdG9yZSBDb21wdHJvbGxlciBhZGRyZXNzXG4gIG5ldHdvcmtzID0gbmV0d29ya3Muc2V0SW4oWydDb250cmFjdHMnLCB0YXJnZXROYW1lXSwgY29udHJhY3RUYXJnZXQuX2FkZHJlc3MpO1xuICB3b3JsZCA9IHdvcmxkLnNldEluKFsnY29udHJhY3REYXRhJywgJ0NvbnRyYWN0cycsIHRhcmdldE5hbWVdLCBjb250cmFjdFRhcmdldC5fYWRkcmVzcyk7XG5cbiAgbmV0d29ya3NBQkkgPSBuZXR3b3Jrc0FCSS5zZXQodGFyZ2V0TmFtZSwgZnVsbEFCSSk7XG5cbiAgbGV0IG1lcmdlZENvbnRyYWN0ID0gbmV3IHdvcmxkLndlYjMuZXRoLkNvbnRyYWN0KGZ1bGxBQkksIGNvbnRyYWN0VGFyZ2V0Ll9hZGRyZXNzLCB7fSk7XG5cbiAgLy8vIFhYWFNcbiAgd29ybGQgPSB3b3JsZC5zZXRJbihcbiAgICBbJ2NvbnRyYWN0SW5kZXgnLCBjb250cmFjdFRhcmdldC5fYWRkcmVzcy50b0xvd2VyQ2FzZSgpXSxcbiAgICBzZXRDb250cmFjdE5hbWUodGFyZ2V0TmFtZSwgPENvbnRyYWN0Pjx1bmtub3duPm1lcmdlZENvbnRyYWN0KVxuICApO1xuXG4gIC8vIERvbid0IHdyaXRlIGR1cmluZyBhIGRyeS1ydW5cbiAgaWYgKCF3b3JsZC5kcnlSdW4pIHtcbiAgICB3b3JsZCA9IGF3YWl0IHdyaXRlTmV0d29ya0ZpbGUod29ybGQsIG5ldHdvcmtzLCBmYWxzZSk7XG4gICAgd29ybGQgPSBhd2FpdCB3cml0ZU5ldHdvcmtGaWxlKHdvcmxkLCBuZXR3b3Jrc0FCSSwgdHJ1ZSk7XG4gIH1cblxuICByZXR1cm4gd29ybGQ7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsb2FkQ29udHJhY3RzKHdvcmxkOiBXb3JsZCk6IFByb21pc2U8W1dvcmxkLCBzdHJpbmdbXV0+IHtcbiAgbGV0IG5ldHdvcmtzID0gYXdhaXQgcmVhZE5ldHdvcmtGaWxlKHdvcmxkLCBmYWxzZSk7XG4gIGxldCBuZXR3b3Jrc0FCSSA9IGF3YWl0IHJlYWROZXR3b3JrRmlsZSh3b3JsZCwgdHJ1ZSk7XG5cbiAgcmV0dXJuIGxvYWRDb250cmFjdERhdGEod29ybGQsIG5ldHdvcmtzLCBuZXR3b3Jrc0FCSSk7XG59XG5cbmZ1bmN0aW9uIHVwZGF0ZUV2ZW50RGVjb2Rlcih3b3JsZDogV29ybGQsIGNvbnRyYWN0OiBhbnkpIHtcbiAgY29uc3QgdXBkYXRlZEV2ZW50RGVjb2RlciA9IGNvbnRyYWN0Ll9qc29uSW50ZXJmYWNlXG4gICAgLmZpbHRlcihpID0+IGkudHlwZSA9PSAnZXZlbnQnKVxuICAgIC5yZWR1Y2UoKGFjY3VtLCBldmVudCkgPT4ge1xuICAgICAgY29uc3QgeyBhbm9ueW1vdXMsIGlucHV0cywgc2lnbmF0dXJlIH0gPSBldmVudDtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLmFjY3VtLFxuICAgICAgICBbc2lnbmF0dXJlXTogbG9nID0+IHtcbiAgICAgICAgICBsZXQgYXJnVG9waWNzID0gYW5vbnltb3VzID8gbG9nLnRvcGljcyA6IGxvZy50b3BpY3Muc2xpY2UoMSk7XG4gICAgICAgICAgcmV0dXJuIHdvcmxkLndlYjMuZXRoLmFiaS5kZWNvZGVMb2coaW5wdXRzLCBsb2cuZGF0YSwgYXJnVG9waWNzKTtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9LCB3b3JsZC5ldmVudERlY29kZXIpO1xuXG4gIHJldHVybiB3b3JsZC5zZXQoJ2V2ZW50RGVjb2RlcicsIHVwZGF0ZWRFdmVudERlY29kZXIpXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsb2FkQ29udHJhY3REYXRhKFxuICB3b3JsZDogV29ybGQsXG4gIG5ldHdvcmtzOiBOZXR3b3JrcyxcbiAgbmV0d29ya3NBQkk6IE5ldHdvcmtzXG4pOiBQcm9taXNlPFtXb3JsZCwgc3RyaW5nW11dPiB7XG4gIC8vIFB1bGwgb2ZmIGNvbnRyYWN0cyB2YWx1ZSBhbmQgdGhlIHJlc3QgaXMgXCJleHRyYVwiXG4gIGxldCBjb250cmFjdEluZm86IHN0cmluZ1tdID0gW107XG4gIGxldCBjb250cmFjdHMgPSBuZXR3b3Jrcy5nZXQoJ0NvbnRyYWN0cycpIHx8IE1hcCh7fSk7XG5cbiAgd29ybGQgPSBjb250cmFjdHMucmVkdWNlKCh3b3JsZDogV29ybGQsIGFkZHJlc3M6IHN0cmluZywgbmFtZTogc3RyaW5nKSA9PiB7XG4gICAgbGV0IGFiaTogQWJpSXRlbVtdID0gbmV0d29ya3NBQkkuaGFzKG5hbWUpID8gbmV0d29ya3NBQkkuZ2V0KG5hbWUpLnRvSlMoKSA6IFtdO1xuICAgIGxldCBjb250cmFjdCA9IG5ldyB3b3JsZC53ZWIzLmV0aC5Db250cmFjdChhYmksIGFkZHJlc3MsIHt9KTtcblxuICAgIHdvcmxkID0gdXBkYXRlRXZlbnREZWNvZGVyKHdvcmxkLCBjb250cmFjdCk7XG5cbiAgICBjb250cmFjdEluZm8ucHVzaChgJHtuYW1lfTogJHthZGRyZXNzfWApO1xuXG4gICAgLy8gU3RvcmUgdGhlIGNvbnRyYWN0XG4gICAgLy8gWFhYU1xuICAgIHJldHVybiB3b3JsZC5zZXRJbihbJ2NvbnRyYWN0SW5kZXgnLCAoPGFueT5jb250cmFjdCkuX2FkZHJlc3MudG9Mb3dlckNhc2UoKV0sIHNldENvbnRyYWN0TmFtZShuYW1lLCA8Q29udHJhY3Q+PHVua25vd24+Y29udHJhY3QpKTtcbiAgfSwgd29ybGQpO1xuXG4gIHdvcmxkID0gd29ybGQudXBkYXRlKCdjb250cmFjdERhdGEnLCBjb250cmFjdERhdGEgPT4gY29udHJhY3REYXRhLm1lcmdlRGVlcChuZXR3b3JrcykpO1xuXG4gIHJldHVybiBbd29ybGQsIGNvbnRyYWN0SW5mb107XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzdG9yZUFuZFNhdmVDb250cmFjdDxUPihcbiAgd29ybGQ6IFdvcmxkLFxuICBjb250cmFjdDogQ29udHJhY3QsXG4gIG5hbWU6IHN0cmluZyxcbiAgaW52b2thdGlvbjogSW52b2thdGlvbjxUPiB8IG51bGwsXG4gIGV4dHJhRGF0YTogRXh0cmFEYXRhW11cbik6IFByb21pc2U8V29ybGQ+IHtcbiAgZXh0cmFEYXRhLnB1c2goeyBpbmRleDogWydDb250cmFjdHMnLCBuYW1lXSwgZGF0YTogY29udHJhY3QuX2FkZHJlc3MgfSk7XG4gIGlmIChjb250cmFjdC5jb25zdHJ1Y3RvckFiaSkge1xuICAgIGV4dHJhRGF0YS5wdXNoKHsgaW5kZXg6IFsnQ29uc3RydWN0b3JzJywgbmFtZV0sIGRhdGE6IGNvbnRyYWN0LmNvbnN0cnVjdG9yQWJpIH0pO1xuICB9XG4gIGlmIChpbnZva2F0aW9uICYmIGludm9rYXRpb24ucmVjZWlwdCkge1xuICAgIGV4dHJhRGF0YS5wdXNoKHsgaW5kZXg6IFsnQmxvY2tzJywgbmFtZV0sIGRhdGE6IGludm9rYXRpb24ucmVjZWlwdC5ibG9ja051bWJlciB9KTtcbiAgfVxuXG4gIHdvcmxkID0gc3RvcmVDb250cmFjdCh3b3JsZCwgY29udHJhY3QsIG5hbWUsIGV4dHJhRGF0YSk7XG4gIHdvcmxkID0gYXdhaXQgc2F2ZUNvbnRyYWN0KHdvcmxkLCBjb250cmFjdCwgbmFtZSwgZXh0cmFEYXRhKTtcblxuICByZXR1cm4gd29ybGQ7XG59XG4iXX0=