"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.processTimelockEvent = exports.timelockCommands = void 0;
const World_1 = require("../World");
const TimelockBuilder_1 = require("../Builder/TimelockBuilder");
const Invokation_1 = require("../Invokation");
const CoreValue_1 = require("../CoreValue");
const Value_1 = require("../Value");
const Command_1 = require("../Command");
const ContractLookup_1 = require("../ContractLookup");
const Verify_1 = require("../Verify");
const Utils_1 = require("../Utils");
async function genTimelock(world, from, params) {
    let { world: nextWorld, timelock, timelockData } = await TimelockBuilder_1.buildTimelock(world, from, params);
    world = nextWorld;
    world = World_1.addAction(world, `Deployed Timelock to address ${timelock._address}`, timelockData.invokation);
    return world;
}
async function acceptAdmin(world, from, timeLock) {
    return World_1.addAction(world, `Set Timelock admin to ${from}`, await Invokation_1.invoke(world, timeLock.methods.acceptAdmin(), from));
}
async function setPendingAdmin(world, from, timeLock, admin) {
    return World_1.addAction(world, `Set Timelock admin to ${admin}`, await Invokation_1.invoke(world, timeLock.methods.setPendingAdmin(admin), from));
}
async function setAdmin(world, from, timeLock, admin) {
    return World_1.addAction(world, `Set Timelock admin to ${admin}`, await Invokation_1.invoke(world, timeLock.methods.harnessSetAdmin(admin), from));
}
async function setDelay(world, from, timeLock, delay) {
    return World_1.addAction(world, `Set Timelock delay to ${delay.show()}`, await Invokation_1.invoke(world, timeLock.methods.setDelay(delay.encode()), from));
}
async function harnessFastForward(world, from, timeLock, seconds) {
    return World_1.addAction(world, `Set Timelock blockTimestamp forward by ${seconds.show()}`, await Invokation_1.invoke(world, timeLock.methods.harnessFastForward(seconds.encode()), from));
}
async function harnessSetBlockTimestamp(world, from, timeLock, seconds) {
    return World_1.addAction(world, `Set Timelock blockTimestamp to ${seconds.show()}`, await Invokation_1.invoke(world, timeLock.methods.harnessSetBlockTimestamp(seconds.encode()), from));
}
async function queueTransaction(world, from, timeLock, target, value, signature, data, eta) {
    const dataArgs = Utils_1.decodeParameters(world, signature, data);
    const etaString = eta.show();
    const dateFromEta = new Date(Number(etaString) * 1000);
    return World_1.addAction(world, `Queue transaction on Timelock with target: ${target}\nvalue: ${value.show()}\nsignature: ${signature}\ndata: ${data} (args: ${dataArgs.join(', ')})\neta: ${etaString} (${dateFromEta.toString()})`, await Invokation_1.invoke(world, timeLock.methods.queueTransaction(target, value.encode(), signature, data, eta.encode()), from));
}
async function cancelTransaction(world, from, timeLock, target, value, signature, data, eta) {
    return World_1.addAction(world, `Cancel transaction on Timelock with target: ${target} value: ${value.show()} signature: ${signature} data: ${data} eta: ${eta.show()}`, await Invokation_1.invoke(world, timeLock.methods.cancelTransaction(target, value.encode(), signature, data, eta.encode()), from));
}
async function executeTransaction(world, from, timeLock, target, value, signature, data, eta) {
    const dataArgs = Utils_1.decodeParameters(world, signature, data);
    const etaString = eta.show();
    const dateFromEta = new Date(Number(etaString) * 1000);
    return World_1.addAction(world, `Execute transaction on Timelock with target: ${target}\nvalue: ${value.show()}\nsignature: ${signature}\ndata: ${data} (args: ${dataArgs.join(', ')})\neta: ${etaString} (${dateFromEta.toString()})`, await Invokation_1.invoke(world, timeLock.methods.executeTransaction(target, value.encode(), signature, data, eta.encode()), from));
}
async function verifyTimelock(world, timelock, apiKey, contractName) {
    if (world.isLocalNetwork()) {
        world.printer.printLine(`Politely declining to verify on local network: ${world.network}.`);
    }
    else {
        await Verify_1.verify(world, apiKey, 'Timelock', contractName, timelock._address);
    }
    return world;
}
function timelockCommands() {
    return [
        new Command_1.Command(`
        #### Deploy

        * "Deploy ...params" - Generates a new price oracle proxy
          * E.g. "Timelock Deploy Geoff 604800"
      `, 'Deploy', [new Command_1.Arg('params', CoreValue_1.getEventV, { variadic: true })], (world, from, { params }) => genTimelock(world, from, params.val)),
        new Command_1.Command(`
        #### FastForward

        * "FastForward <Seconds>" - Sets the blockTimestamp of the TimelockHarness forward
        * E.g. "Timelock FastForward 604800"
    `, 'FastForward', [new Command_1.Arg('timelock', ContractLookup_1.getTimelock, { implicit: true }), new Command_1.Arg('seconds', CoreValue_1.getNumberV)], (world, from, { timelock, seconds }) => harnessFastForward(world, from, timelock, seconds)),
        new Command_1.Command(`
        #### SetBlockTimestamp

        * "SetBlockTimestamp <Seconds>" - Sets the blockTimestamp of the TimelockHarness
        * E.g. "Timelock SetBlockTimestamp 1569973599"
    `, 'SetBlockTimestamp', [new Command_1.Arg('timelock', ContractLookup_1.getTimelock, { implicit: true }), new Command_1.Arg('seconds', CoreValue_1.getNumberV)], (world, from, { timelock, seconds }) => harnessSetBlockTimestamp(world, from, timelock, seconds)),
        new Command_1.Command(`
        #### SetDelay

        * "SetDelay <Delay>" - Sets the delay for the Timelock
        * E.g. "Timelock SetDelay 604800"
    `, 'SetDelay', [new Command_1.Arg('timelock', ContractLookup_1.getTimelock, { implicit: true }), new Command_1.Arg('delay', CoreValue_1.getNumberV)], (world, from, { timelock, delay }) => setDelay(world, from, timelock, delay)),
        new Command_1.Command(`
        #### AcceptAdmin

        * "AcceptAdmin" - Accept the admin for the Timelock
        * E.g. "Timelock AcceptAdmin"
    `, 'AcceptAdmin', [new Command_1.Arg('timelock', ContractLookup_1.getTimelock, { implicit: true })], (world, from, { timelock }) => acceptAdmin(world, from, timelock)),
        new Command_1.Command(`
        #### SetPendingAdmin

        * "SetPendingAdmin <Address>" - Sets the pending admin for the Timelock
        * E.g. "Timelock SetPendingAdmin \"0x0000000000000000000000000000000000000000\""
    `, 'SetPendingAdmin', [new Command_1.Arg('timelock', ContractLookup_1.getTimelock, { implicit: true }), new Command_1.Arg('admin', CoreValue_1.getAddressV)], (world, from, { timelock, admin }) => setPendingAdmin(world, from, timelock, admin.val)),
        new Command_1.Command(`
        #### SetAdmin

        * "SetAdmin <Address>" - Sets the admin for the Timelock through the harness
        * E.g. "Timelock SetAdmin \"0x0000000000000000000000000000000000000000\""
    `, 'SetAdmin', [new Command_1.Arg('timelock', ContractLookup_1.getTimelock, { implicit: true }), new Command_1.Arg('admin', CoreValue_1.getAddressV)], (world, from, { timelock, admin }) => setAdmin(world, from, timelock, admin.val)),
        new Command_1.Command(`
        #### QueueTransaction

        * "QueueTransaction target:<Address> value:<Number> eta:<Number> signature:<String> ...funArgs:<CoreValue>" - Queues a transaction for the Timelock
        * E.g. "Timelock QueueTransaction \"0x0000000000000000000000000000000000000000\" 0 1569286014 \"setDelay(uint256)\" 60680"
        *
    `, 'QueueTransaction', [
            new Command_1.Arg('timelock', ContractLookup_1.getTimelock, { implicit: true }),
            new Command_1.Arg('target', CoreValue_1.getAddressV),
            new Command_1.Arg('value', CoreValue_1.getNumberV),
            new Command_1.Arg('eta', CoreValue_1.getNumberV),
            new Command_1.Arg('signature', CoreValue_1.getStringV),
            new Command_1.Arg('data', CoreValue_1.getCoreValue, { variadic: true, mapped: true })
        ], (world, from, { timelock, target, value, signature, data, eta }) => {
            const encodedData = Utils_1.encodeParameters(world, signature.val, data.map(a => a.val));
            return queueTransaction(world, from, timelock, target.val, value, signature.val, encodedData, eta);
        }),
        new Command_1.Command(`
        #### CancelTransaction

        * "CancelTransaction target:<Address> value:<Number> eta:<Number> signature:<String> ...funArgs:<CoreValue>" - Cancels a transaction from the Timelock
        * E.g. "Timelock CancelTransaction \"0x0000000000000000000000000000000000000000\" 0 1569286014 \"setDelay(uint256)\" 60680"
    `, 'CancelTransaction', [
            new Command_1.Arg('timelock', ContractLookup_1.getTimelock, { implicit: true }),
            new Command_1.Arg('target', CoreValue_1.getAddressV),
            new Command_1.Arg('value', CoreValue_1.getNumberV),
            new Command_1.Arg('eta', CoreValue_1.getNumberV),
            new Command_1.Arg('signature', CoreValue_1.getStringV),
            new Command_1.Arg('data', CoreValue_1.getCoreValue, { variadic: true, mapped: true })
        ], (world, from, { timelock, target, value, signature, data, eta }) => {
            const encodedData = Utils_1.encodeParameters(world, signature.val, data.map(a => a.val));
            return cancelTransaction(world, from, timelock, target.val, value, signature.val, encodedData, eta);
        }),
        new Command_1.Command(`
        #### ExecuteTransaction

        * "ExecuteTransaction target:<Address> value:<Number> eta:<Number> signature:<String> ...funArgs:<CoreValue>" - Executes a transaction from the Timelock
        * E.g. "Timelock ExecuteTransaction \"0x0000000000000000000000000000000000000000\" 0 1569286014 \"setDelay(uint256)\" 60680"
    `, 'ExecuteTransaction', [
            new Command_1.Arg('timelock', ContractLookup_1.getTimelock, { implicit: true }),
            new Command_1.Arg('target', CoreValue_1.getAddressV),
            new Command_1.Arg('value', CoreValue_1.getNumberV),
            new Command_1.Arg('eta', CoreValue_1.getNumberV),
            new Command_1.Arg('signature', CoreValue_1.getStringV),
            new Command_1.Arg('data', CoreValue_1.getCoreValue, { variadic: true, mapped: true })
        ], (world, from, { timelock, target, value, signature, data, eta }) => {
            const encodedData = Utils_1.encodeParameters(world, signature.val, data.map(a => a.val));
            return executeTransaction(world, from, timelock, target.val, value, signature.val, encodedData, eta);
        }),
        new Command_1.View(`
        #### Verify

        * "Verify apiKey:<String> contractName:<String>=Timelock" - Verifies Timelock in Etherscan
          * E.g. "Timelock Verify "myApiKey"
      `, 'Verify', [
            new Command_1.Arg('timelock', ContractLookup_1.getTimelock, { implicit: true }),
            new Command_1.Arg('apiKey', CoreValue_1.getStringV),
            new Command_1.Arg('contractName', CoreValue_1.getStringV, { default: new Value_1.StringV('Timelock') })
        ], (world, { timelock, apiKey, contractName }) => verifyTimelock(world, timelock, apiKey.val, contractName.val))
    ];
}
exports.timelockCommands = timelockCommands;
async function processTimelockEvent(world, event, from) {
    return await Command_1.processCommandEvent('Timelock', timelockCommands(), world, event, from);
}
exports.processTimelockEvent = processTimelockEvent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGltZWxvY2tFdmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9FdmVudC9UaW1lbG9ja0V2ZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLG9DQUE0QztBQUU1QyxnRUFBeUU7QUFDekUsOENBQXVDO0FBQ3ZDLDRDQUE0RjtBQUM1RixvQ0FBOEQ7QUFDOUQsd0NBQXFFO0FBQ3JFLHNEQUFnRDtBQUNoRCxzQ0FBbUM7QUFDbkMsb0NBQThEO0FBRTlELEtBQUssVUFBVSxXQUFXLENBQUMsS0FBWSxFQUFFLElBQVksRUFBRSxNQUFhO0lBQ2xFLElBQUksRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxZQUFZLEVBQUUsR0FBRyxNQUFNLCtCQUFhLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztJQUM1RixLQUFLLEdBQUcsU0FBUyxDQUFDO0lBRWxCLEtBQUssR0FBRyxpQkFBUyxDQUFDLEtBQUssRUFBRSxnQ0FBZ0MsUUFBUSxDQUFDLFFBQVEsRUFBRSxFQUFFLFlBQVksQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUV2RyxPQUFPLEtBQUssQ0FBQztBQUNmLENBQUM7QUFFRCxLQUFLLFVBQVUsV0FBVyxDQUFDLEtBQVksRUFBRSxJQUFZLEVBQUUsUUFBa0I7SUFDdkUsT0FBTyxpQkFBUyxDQUNkLEtBQUssRUFDTCx5QkFBeUIsSUFBSSxFQUFFLEVBQy9CLE1BQU0sbUJBQU0sQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FDMUQsQ0FBQztBQUNKLENBQUM7QUFFRCxLQUFLLFVBQVUsZUFBZSxDQUM1QixLQUFZLEVBQ1osSUFBWSxFQUNaLFFBQWtCLEVBQ2xCLEtBQWE7SUFFYixPQUFPLGlCQUFTLENBQ2QsS0FBSyxFQUNMLHlCQUF5QixLQUFLLEVBQUUsRUFDaEMsTUFBTSxtQkFBTSxDQUFDLEtBQUssRUFBRSxR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QUFLLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxNQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxTQUFTLENBQUMsR0FBRyxFQUFFLFdBQVcsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUN2RyxDQUFDLENBQ0Y7UUFDRCxJQUFJLGNBQUksQ0FDTjs7Ozs7T0FLQyxFQUNELFFBQVEsRUFDUjtZQUNFLElBQUksYUFBRyxDQUFDLFVBQVUsRUFBRSw0QkFBVyxFQUFFLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDO1lBQ3BELElBQUksYUFBRyxDQUFDLFFBQVEsRUFBRSxzQkFBVSxDQUFDO1lBQzdCLElBQUksYUFBRyxDQUFDLGNBQWMsRUFBRSxzQkFBVSxFQUFFLEVBQUUsT0FBTyxFQUFFLElBQUksZUFBTyxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUM7U0FDMUUsRUFDRCxDQUFDLEtBQUssRUFBRSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLEVBQUUsRUFBRSxDQUM1QyxjQUFjLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxNQUFNLENBQUMsR0FBRyxFQUFFLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FDaEU7S0FDRixDQUFDO0FBQ0osQ0FBQztBQXJMRCw0Q0FxTEM7QUFFTSxLQUFLLFVBQVUsb0JBQW9CLENBQUMsS0FBWSxFQUFFLEtBQVksRUFBRSxJQUFtQjtJQUN4RixPQUFPLE1BQU0sNkJBQW1CLENBQU0sVUFBVSxFQUFFLGdCQUFnQixFQUFFLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztBQUM1RixDQUFDO0FBRkQsb0RBRUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudCB9IGZyb20gJy4uL0V2ZW50JztcbmltcG9ydCB7IGFkZEFjdGlvbiwgV29ybGQgfSBmcm9tICcuLi9Xb3JsZCc7XG5pbXBvcnQgeyBUaW1lbG9jayB9IGZyb20gJy4uL0NvbnRyYWN0L1RpbWVsb2NrJztcbmltcG9ydCB7IGJ1aWxkVGltZWxvY2ssIFRpbWVsb2NrRGF0YSB9IGZyb20gJy4uL0J1aWxkZXIvVGltZWxvY2tCdWlsZGVyJztcbmltcG9ydCB7IGludm9rZSB9IGZyb20gJy4uL0ludm9rYXRpb24nO1xuaW1wb3J0IHsgZ2V0QWRkcmVzc1YsIGdldEV2ZW50ViwgZ2V0TnVtYmVyViwgZ2V0U3RyaW5nViwgZ2V0Q29yZVZhbHVlIH0gZnJvbSAnLi4vQ29yZVZhbHVlJztcbmltcG9ydCB7IEFkZHJlc3NWLCBFdmVudFYsIE51bWJlclYsIFN0cmluZ1YgfSBmcm9tICcuLi9WYWx1ZSc7XG5pbXBvcnQgeyBBcmcsIENvbW1hbmQsIHByb2Nlc3NDb21tYW5kRXZlbnQsIFZpZXcgfSBmcm9tICcuLi9Db21tYW5kJztcbmltcG9ydCB7IGdldFRpbWVsb2NrIH0gZnJvbSAnLi4vQ29udHJhY3RMb29rdXAnO1xuaW1wb3J0IHsgdmVyaWZ5IH0gZnJvbSAnLi4vVmVyaWZ5JztcbmltcG9ydCB7IGRlY29kZVBhcmFtZXRlcnMsIGVuY29kZVBhcmFtZXRlcnMgfSBmcm9tICcuLi9VdGlscyc7XG5cbmFzeW5jIGZ1bmN0aW9uIGdlblRpbWVsb2NrKHdvcmxkOiBXb3JsZCwgZnJvbTogc3RyaW5nLCBwYXJhbXM6IEV2ZW50KTogUHJvbWlzZTxXb3JsZD4ge1xuICBsZXQgeyB3b3JsZDogbmV4dFdvcmxkLCB0aW1lbG9jaywgdGltZWxvY2tEYXRhIH0gPSBhd2FpdCBidWlsZFRpbWVsb2NrKHdvcmxkLCBmcm9tLCBwYXJhbXMpO1xuICB3b3JsZCA9IG5leHRXb3JsZDtcblxuICB3b3JsZCA9IGFkZEFjdGlvbih3b3JsZCwgYERlcGxveWVkIFRpbWVsb2NrIHRvIGFkZHJlc3MgJHt0aW1lbG9jay5fYWRkcmVzc31gLCB0aW1lbG9ja0RhdGEuaW52b2thdGlvbik7XG5cbiAgcmV0dXJuIHdvcmxkO1xufVxuXG5hc3luYyBmdW5jdGlvbiBhY2NlcHRBZG1pbih3b3JsZDogV29ybGQsIGZyb206IHN0cmluZywgdGltZUxvY2s6IFRpbWVsb2NrKTogUHJvbWlzZTxXb3JsZD4ge1xuICByZXR1cm4gYWRkQWN0aW9uKFxuICAgIHdvcmxkLFxuICAgIGBTZXQgVGltZWxvY2sgYWRtaW4gdG8gJHtmcm9tfWAsXG4gICAgYXdhaXQgaW52b2tlKHdvcmxkLCB0aW1lTG9jay5tZXRob2RzLmFjY2VwdEFkbWluKCksIGZyb20pXG4gICk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldFBlbmRpbmdBZG1pbihcbiAgd29ybGQ6IFdvcmxkLFxuICBmcm9tOiBzdHJpbmcsXG4gIHRpbWVMb2NrOiBUaW1lbG9jayxcbiAgYWRtaW46IHN0cmluZ1xuKTogUHJvbWlzZTxXb3JsZD4ge1xuICByZXR1cm4gYWRkQWN0aW9uKFxuICAgIHdvcmxkLFxuICAgIGBTZXQgVGltZWxvY2sgYWRtaW4gdG8gJHthZG1pbn1gLFxuICAgIGF3YWl0IGludm9rZSh3b3JsZCwgdGltZUxvY2subWV0aG9kcy5zZXRQZW5kaW5nQWRtaW4oYWRtaW4pLCBmcm9tKVxuICApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXRBZG1pbihcbiAgd29ybGQ6IFdvcmxkLFxuICBmcm9tOiBzdHJpbmcsXG4gIHRpbWVMb2NrOiBUaW1lbG9jayxcbiAgYWRtaW46IHN0cmluZ1xuKTogUHJvbWlzZTxXb3JsZD4ge1xuICByZXR1cm4gYWRkQWN0aW9uKFxuICAgIHdvcmxkLFxuICAgIGBTZXQgVGltZWxvY2sgYWRtaW4gdG8gJHthZG1pbn1gLFxuICAgIGF3YWl0IGludm9rZSh3b3JsZCwgdGltZUxvY2subWV0aG9kcy5oYXJuZXNzU2V0QWRtaW4oYWRtaW4pLCBmcm9tKVxuICApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXREZWxheSh3b3JsZDogV29ybGQsIGZyb206IHN0cmluZywgdGltZUxvY2s6IFRpbWVsb2NrLCBkZWxheTogTnVtYmVyVik6IFByb21pc2U8V29ybGQ+IHtcbiAgcmV0dXJuIGFkZEFjdGlvbihcbiAgICB3b3JsZCxcbiAgICBgU2V0IFRpbWVsb2NrIGRlbGF5IHRvICR7ZGVsYXkuc2hvdygpfWAsXG4gICAgYXdhaXQgaW52b2tlKHdvcmxkLCB0aW1lTG9jay5tZXRob2RzLnNldERlbGF5KGRlbGF5LmVuY29kZSgpKSwgZnJvbSlcbiAgKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gaGFybmVzc0Zhc3RGb3J3YXJkKFxuICB3b3JsZDogV29ybGQsXG4gIGZyb206IHN0cmluZyxcbiAgdGltZUxvY2s6IFRpbWVsb2NrLFxuICBzZWNvbmRzOiBOdW1iZXJWXG4pOiBQcm9taXNlPFdvcmxkPiB7XG4gIHJldHVybiBhZGRBY3Rpb24oXG4gICAgd29ybGQsXG4gICAgYFNldCBUaW1lbG9jayBibG9ja1RpbWVzdGFtcCBmb3J3YXJkIGJ5ICR7c2Vjb25kcy5zaG93KCl9YCxcbiAgICBhd2FpdCBpbnZva2Uod29ybGQsIHRpbWVMb2NrLm1ldGhvZHMuaGFybmVzc0Zhc3RGb3J3YXJkKHNlY29uZHMuZW5jb2RlKCkpLCBmcm9tKVxuICApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBoYXJuZXNzU2V0QmxvY2tUaW1lc3RhbXAoXG4gIHdvcmxkOiBXb3JsZCxcbiAgZnJvbTogc3RyaW5nLFxuICB0aW1lTG9jazogVGltZWxvY2ssXG4gIHNlY29uZHM6IE51bWJlclZcbik6IFByb21pc2U8V29ybGQ+IHtcbiAgcmV0dXJuIGFkZEFjdGlvbihcbiAgICB3b3JsZCxcbiAgICBgU2V0IFRpbWVsb2NrIGJsb2NrVGltZXN0YW1wIHRvICR7c2Vjb25kcy5zaG93KCl9YCxcbiAgICBhd2FpdCBpbnZva2Uod29ybGQsIHRpbWVMb2NrLm1ldGhvZHMuaGFybmVzc1NldEJsb2NrVGltZXN0YW1wKHNlY29uZHMuZW5jb2RlKCkpLCBmcm9tKVxuICApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBxdWV1ZVRyYW5zYWN0aW9uKFxuICB3b3JsZDogV29ybGQsXG4gIGZyb206IHN0cmluZyxcbiAgdGltZUxvY2s6IFRpbWVsb2NrLFxuICB0YXJnZXQ6IHN0cmluZyxcbiAgdmFsdWU6IE51bWJlclYsXG4gIHNpZ25hdHVyZTogc3RyaW5nLFxuICBkYXRhOiBzdHJpbmcsXG4gIGV0YTogTnVtYmVyVlxuKTogUHJvbWlzZTxXb3JsZD4ge1xuICBjb25zdCBkYXRhQXJncyA9IGRlY29kZVBhcmFtZXRlcnMod29ybGQsIHNpZ25hdHVyZSwgZGF0YSk7XG4gIGNvbnN0IGV0YVN0cmluZyA9IGV0YS5zaG93KCk7XG4gIGNvbnN0IGRhdGVGcm9tRXRhID0gbmV3IERhdGUoTnVtYmVyKGV0YVN0cmluZykgKiAxMDAwKTtcblxuICByZXR1cm4gYWRkQWN0aW9uKFxuICAgIHdvcmxkLFxuICAgIGBRdWV1ZSB0cmFuc2FjdGlvbiBvbiBUaW1lbG9jayB3aXRoIHRhcmdldDogJHt0YXJnZXR9XFxudmFsdWU6ICR7dmFsdWUuc2hvdygpfVxcbnNpZ25hdHVyZTogJHtzaWduYXR1cmV9XFxuZGF0YTogJHtkYXRhfSAoYXJnczogJHtkYXRhQXJncy5qb2luKFxuICAgICAgJywgJ1xuICAgICl9KVxcbmV0YTogJHtldGFTdHJpbmd9ICgke2RhdGVGcm9tRXRhLnRvU3RyaW5nKCl9KWAsXG4gICAgYXdhaXQgaW52b2tlKFxuICAgICAgd29ybGQsXG4gICAgICB0aW1lTG9jay5tZXRob2RzLnF1ZXVlVHJhbnNhY3Rpb24odGFyZ2V0LCB2YWx1ZS5lbmNvZGUoKSwgc2lnbmF0dXJlLCBkYXRhLCBldGEuZW5jb2RlKCkpLFxuICAgICAgZnJvbVxuICAgIClcbiAgKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY2FuY2VsVHJhbnNhY3Rpb24oXG4gIHdvcmxkOiBXb3JsZCxcbiAgZnJvbTogc3RyaW5nLFxuICB0aW1lTG9jazogVGltZWxvY2ssXG4gIHRhcmdldDogc3RyaW5nLFxuICB2YWx1ZTogTnVtYmVyVixcbiAgc2lnbmF0dXJlOiBzdHJpbmcsXG4gIGRhdGE6IHN0cmluZyxcbiAgZXRhOiBOdW1iZXJWXG4pOiBQcm9taXNlPFdvcmxkPiB7XG4gIHJldHVybiBhZGRBY3Rpb24oXG4gICAgd29ybGQsXG4gICAgYENhbmNlbCB0cmFuc2FjdGlvbiBvbiBUaW1lbG9jayB3aXRoIHRhcmdldDogJHt0YXJnZXR9IHZhbHVlOiAke3ZhbHVlLnNob3coKX0gc2lnbmF0dXJlOiAke3NpZ25hdHVyZX0gZGF0YTogJHtkYXRhfSBldGE6ICR7ZXRhLnNob3coKX1gLFxuICAgIGF3YWl0IGludm9rZShcbiAgICAgIHdvcmxkLFxuICAgICAgdGltZUxvY2subWV0aG9kcy5jYW5jZWxUcmFuc2FjdGlvbih0YXJnZXQsIHZhbHVlLmVuY29kZSgpLCBzaWduYXR1cmUsIGRhdGEsIGV0YS5lbmNvZGUoKSksXG4gICAgICBmcm9tXG4gICAgKVxuICApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBleGVjdXRlVHJhbnNhY3Rpb24oXG4gIHdvcmxkOiBXb3JsZCxcbiAgZnJvbTogc3RyaW5nLFxuICB0aW1lTG9jazogVGltZWxvY2ssXG4gIHRhcmdldDogc3RyaW5nLFxuICB2YWx1ZTogTnVtYmVyVixcbiAgc2lnbmF0dXJlOiBzdHJpbmcsXG4gIGRhdGE6IHN0cmluZyxcbiAgZXRhOiBOdW1iZXJWXG4pOiBQcm9taXNlPFdvcmxkPiB7XG4gIGNvbnN0IGRhdGFBcmdzID0gZGVjb2RlUGFyYW1ldGVycyh3b3JsZCwgc2lnbmF0dXJlLCBkYXRhKTtcbiAgY29uc3QgZXRhU3RyaW5nID0gZXRhLnNob3coKTtcbiAgY29uc3QgZGF0ZUZyb21FdGEgPSBuZXcgRGF0ZShOdW1iZXIoZXRhU3RyaW5nKSAqIDEwMDApO1xuXG4gIHJldHVybiBhZGRBY3Rpb24oXG4gICAgd29ybGQsXG4gICAgYEV4ZWN1dGUgdHJhbnNhY3Rpb24gb24gVGltZWxvY2sgd2l0aCB0YXJnZXQ6ICR7dGFyZ2V0fVxcbnZhbHVlOiAke3ZhbHVlLnNob3coKX1cXG5zaWduYXR1cmU6ICR7c2lnbmF0dXJlfVxcbmRhdGE6ICR7ZGF0YX0gKGFyZ3M6ICR7ZGF0YUFyZ3Muam9pbihcbiAgICAgICcsICdcbiAgICApfSlcXG5ldGE6ICR7ZXRhU3RyaW5nfSAoJHtkYXRlRnJvbUV0YS50b1N0cmluZygpfSlgLFxuICAgIGF3YWl0IGludm9rZShcbiAgICAgIHdvcmxkLFxuICAgICAgdGltZUxvY2subWV0aG9kcy5leGVjdXRlVHJhbnNhY3Rpb24odGFyZ2V0LCB2YWx1ZS5lbmNvZGUoKSwgc2lnbmF0dXJlLCBkYXRhLCBldGEuZW5jb2RlKCkpLFxuICAgICAgZnJvbVxuICAgIClcbiAgKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gdmVyaWZ5VGltZWxvY2soXG4gIHdvcmxkOiBXb3JsZCxcbiAgdGltZWxvY2s6IFRpbWVsb2NrLFxuICBhcGlLZXk6IHN0cmluZyxcbiAgY29udHJhY3ROYW1lOiBzdHJpbmdcbik6IFByb21pc2U8V29ybGQ+IHtcbiAgaWYgKHdvcmxkLmlzTG9jYWxOZXR3b3JrKCkpIHtcbiAgICB3b3JsZC5wcmludGVyLnByaW50TGluZShgUG9saXRlbHkgZGVjbGluaW5nIHRvIHZlcmlmeSBvbiBsb2NhbCBuZXR3b3JrOiAke3dvcmxkLm5ldHdvcmt9LmApO1xuICB9IGVsc2Uge1xuICAgIGF3YWl0IHZlcmlmeSh3b3JsZCwgYXBpS2V5LCAnVGltZWxvY2snLCBjb250cmFjdE5hbWUsIHRpbWVsb2NrLl9hZGRyZXNzKTtcbiAgfVxuXG4gIHJldHVybiB3b3JsZDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRpbWVsb2NrQ29tbWFuZHMoKSB7XG4gIHJldHVybiBbXG4gICAgbmV3IENvbW1hbmQ8eyBwYXJhbXM6IEV2ZW50ViB9PihcbiAgICAgIGBcbiAgICAgICAgIyMjIyBEZXBsb3lcblxuICAgICAgICAqIFwiRGVwbG95IC4uLnBhcmFtc1wiIC0gR2VuZXJhdGVzIGEgbmV3IHByaWNlIG9yYWNsZSBwcm94eVxuICAgICAgICAgICogRS5nLiBcIlRpbWVsb2NrIERlcGxveSBHZW9mZiA2MDQ4MDBcIlxuICAgICAgYCxcbiAgICAgICdEZXBsb3knLFxuICAgICAgW25ldyBBcmcoJ3BhcmFtcycsIGdldEV2ZW50ViwgeyB2YXJpYWRpYzogdHJ1ZSB9KV0sXG4gICAgICAod29ybGQsIGZyb20sIHsgcGFyYW1zIH0pID0+IGdlblRpbWVsb2NrKHdvcmxkLCBmcm9tLCBwYXJhbXMudmFsKVxuICAgICksXG4gICAgbmV3IENvbW1hbmQ8eyB0aW1lbG9jazogVGltZWxvY2s7IHNlY29uZHM6IE51bWJlclYgfT4oXG4gICAgICBgXG4gICAgICAgICMjIyMgRmFzdEZvcndhcmRcblxuICAgICAgICAqIFwiRmFzdEZvcndhcmQgPFNlY29uZHM+XCIgLSBTZXRzIHRoZSBibG9ja1RpbWVzdGFtcCBvZiB0aGUgVGltZWxvY2tIYXJuZXNzIGZvcndhcmRcbiAgICAgICAgKiBFLmcuIFwiVGltZWxvY2sgRmFzdEZvcndhcmQgNjA0ODAwXCJcbiAgICBgLFxuICAgICAgJ0Zhc3RGb3J3YXJkJyxcbiAgICAgIFtuZXcgQXJnKCd0aW1lbG9jaycsIGdldFRpbWVsb2NrLCB7IGltcGxpY2l0OiB0cnVlIH0pLCBuZXcgQXJnKCdzZWNvbmRzJywgZ2V0TnVtYmVyVildLFxuICAgICAgKHdvcmxkLCBmcm9tLCB7IHRpbWVsb2NrLCBzZWNvbmRzIH0pID0+IGhhcm5lc3NGYXN0Rm9yd2FyZCh3b3JsZCwgZnJvbSwgdGltZWxvY2ssIHNlY29uZHMpXG4gICAgKSxcbiAgICBuZXcgQ29tbWFuZDx7IHRpbWVsb2NrOiBUaW1lbG9jazsgc2Vjb25kczogTnVtYmVyViB9PihcbiAgICAgIGBcbiAgICAgICAgIyMjIyBTZXRCbG9ja1RpbWVzdGFtcFxuXG4gICAgICAgICogXCJTZXRCbG9ja1RpbWVzdGFtcCA8U2Vjb25kcz5cIiAtIFNldHMgdGhlIGJsb2NrVGltZXN0YW1wIG9mIHRoZSBUaW1lbG9ja0hhcm5lc3NcbiAgICAgICAgKiBFLmcuIFwiVGltZWxvY2sgU2V0QmxvY2tUaW1lc3RhbXAgMTU2OTk3MzU5OVwiXG4gICAgYCxcbiAgICAgICdTZXRCbG9ja1RpbWVzdGFtcCcsXG4gICAgICBbbmV3IEFyZygndGltZWxvY2snLCBnZXRUaW1lbG9jaywgeyBpbXBsaWNpdDogdHJ1ZSB9KSwgbmV3IEFyZygnc2Vjb25kcycsIGdldE51bWJlclYpXSxcbiAgICAgICh3b3JsZCwgZnJvbSwgeyB0aW1lbG9jaywgc2Vjb25kcyB9KSA9PiBoYXJuZXNzU2V0QmxvY2tUaW1lc3RhbXAod29ybGQsIGZyb20sIHRpbWVsb2NrLCBzZWNvbmRzKVxuICAgICksXG4gICAgbmV3IENvbW1hbmQ8eyB0aW1lbG9jazogVGltZWxvY2s7IGRlbGF5OiBOdW1iZXJWIH0+KFxuICAgICAgYFxuICAgICAgICAjIyMjIFNldERlbGF5XG5cbiAgICAgICAgKiBcIlNldERlbGF5IDxEZWxheT5cIiAtIFNldHMgdGhlIGRlbGF5IGZvciB0aGUgVGltZWxvY2tcbiAgICAgICAgKiBFLmcuIFwiVGltZWxvY2sgU2V0RGVsYXkgNjA0ODAwXCJcbiAgICBgLFxuICAgICAgJ1NldERlbGF5JyxcbiAgICAgIFtuZXcgQXJnKCd0aW1lbG9jaycsIGdldFRpbWVsb2NrLCB7IGltcGxpY2l0OiB0cnVlIH0pLCBuZXcgQXJnKCdkZWxheScsIGdldE51bWJlclYpXSxcbiAgICAgICh3b3JsZCwgZnJvbSwgeyB0aW1lbG9jaywgZGVsYXkgfSkgPT4gc2V0RGVsYXkod29ybGQsIGZyb20sIHRpbWVsb2NrLCBkZWxheSlcbiAgICApLFxuICAgIG5ldyBDb21tYW5kPHsgdGltZWxvY2s6IFRpbWVsb2NrIH0+KFxuICAgICAgYFxuICAgICAgICAjIyMjIEFjY2VwdEFkbWluXG5cbiAgICAgICAgKiBcIkFjY2VwdEFkbWluXCIgLSBBY2NlcHQgdGhlIGFkbWluIGZvciB0aGUgVGltZWxvY2tcbiAgICAgICAgKiBFLmcuIFwiVGltZWxvY2sgQWNjZXB0QWRtaW5cIlxuICAgIGAsXG4gICAgICAnQWNjZXB0QWRtaW4nLFxuICAgICAgW25ldyBBcmcoJ3RpbWVsb2NrJywgZ2V0VGltZWxvY2ssIHsgaW1wbGljaXQ6IHRydWUgfSldLFxuICAgICAgKHdvcmxkLCBmcm9tLCB7IHRpbWVsb2NrIH0pID0+IGFjY2VwdEFkbWluKHdvcmxkLCBmcm9tLCB0aW1lbG9jaylcbiAgICApLFxuICAgIG5ldyBDb21tYW5kPHsgdGltZWxvY2s6IFRpbWVsb2NrOyBhZG1pbjogQWRkcmVzc1YgfT4oXG4gICAgICBgXG4gICAgICAgICMjIyMgU2V0UGVuZGluZ0FkbWluXG5cbiAgICAgICAgKiBcIlNldFBlbmRpbmdBZG1pbiA8QWRkcmVzcz5cIiAtIFNldHMgdGhlIHBlbmRpbmcgYWRtaW4gZm9yIHRoZSBUaW1lbG9ja1xuICAgICAgICAqIEUuZy4gXCJUaW1lbG9jayBTZXRQZW5kaW5nQWRtaW4gXFxcIjB4MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMFxcXCJcIlxuICAgIGAsXG4gICAgICAnU2V0UGVuZGluZ0FkbWluJyxcbiAgICAgIFtuZXcgQXJnKCd0aW1lbG9jaycsIGdldFRpbWVsb2NrLCB7IGltcGxpY2l0OiB0cnVlIH0pLCBuZXcgQXJnKCdhZG1pbicsIGdldEFkZHJlc3NWKV0sXG4gICAgICAod29ybGQsIGZyb20sIHsgdGltZWxvY2ssIGFkbWluIH0pID0+IHNldFBlbmRpbmdBZG1pbih3b3JsZCwgZnJvbSwgdGltZWxvY2ssIGFkbWluLnZhbClcbiAgICApLFxuICAgIG5ldyBDb21tYW5kPHsgdGltZWxvY2s6IFRpbWVsb2NrOyBhZG1pbjogQWRkcmVzc1YgfT4oXG4gICAgICBgXG4gICAgICAgICMjIyMgU2V0QWRtaW5cblxuICAgICAgICAqIFwiU2V0QWRtaW4gPEFkZHJlc3M+XCIgLSBTZXRzIHRoZSBhZG1pbiBmb3IgdGhlIFRpbWVsb2NrIHRocm91Z2ggdGhlIGhhcm5lc3NcbiAgICAgICAgKiBFLmcuIFwiVGltZWxvY2sgU2V0QWRtaW4gXFxcIjB4MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMFxcXCJcIlxuICAgIGAsXG4gICAgICAnU2V0QWRtaW4nLFxuICAgICAgW25ldyBBcmcoJ3RpbWVsb2NrJywgZ2V0VGltZWxvY2ssIHsgaW1wbGljaXQ6IHRydWUgfSksIG5ldyBBcmcoJ2FkbWluJywgZ2V0QWRkcmVzc1YpXSxcbiAgICAgICh3b3JsZCwgZnJvbSwgeyB0aW1lbG9jaywgYWRtaW4gfSkgPT4gc2V0QWRtaW4od29ybGQsIGZyb20sIHRpbWVsb2NrLCBhZG1pbi52YWwpXG4gICAgKSxcbiAgICBuZXcgQ29tbWFuZDx7XG4gICAgICB0aW1lbG9jazogVGltZWxvY2s7XG4gICAgICB0YXJnZXQ6IEFkZHJlc3NWO1xuICAgICAgdmFsdWU6IE51bWJlclY7XG4gICAgICBldGE6IE51bWJlclY7XG4gICAgICBzaWduYXR1cmU6IFN0cmluZ1Y7XG4gICAgICBkYXRhOiBTdHJpbmdWW107XG4gICAgfT4oXG4gICAgICBgXG4gICAgICAgICMjIyMgUXVldWVUcmFuc2FjdGlvblxuXG4gICAgICAgICogXCJRdWV1ZVRyYW5zYWN0aW9uIHRhcmdldDo8QWRkcmVzcz4gdmFsdWU6PE51bWJlcj4gZXRhOjxOdW1iZXI+IHNpZ25hdHVyZTo8U3RyaW5nPiAuLi5mdW5BcmdzOjxDb3JlVmFsdWU+XCIgLSBRdWV1ZXMgYSB0cmFuc2FjdGlvbiBmb3IgdGhlIFRpbWVsb2NrXG4gICAgICAgICogRS5nLiBcIlRpbWVsb2NrIFF1ZXVlVHJhbnNhY3Rpb24gXFxcIjB4MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMFxcXCIgMCAxNTY5Mjg2MDE0IFxcXCJzZXREZWxheSh1aW50MjU2KVxcXCIgNjA2ODBcIlxuICAgICAgICAqXG4gICAgYCxcbiAgICAgICdRdWV1ZVRyYW5zYWN0aW9uJyxcbiAgICAgIFtcbiAgICAgICAgbmV3IEFyZygndGltZWxvY2snLCBnZXRUaW1lbG9jaywgeyBpbXBsaWNpdDogdHJ1ZSB9KSxcbiAgICAgICAgbmV3IEFyZygndGFyZ2V0JywgZ2V0QWRkcmVzc1YpLFxuICAgICAgICBuZXcgQXJnKCd2YWx1ZScsIGdldE51bWJlclYpLFxuICAgICAgICBuZXcgQXJnKCdldGEnLCBnZXROdW1iZXJWKSxcbiAgICAgICAgbmV3IEFyZygnc2lnbmF0dXJlJywgZ2V0U3RyaW5nViksXG4gICAgICAgIG5ldyBBcmcoJ2RhdGEnLCBnZXRDb3JlVmFsdWUsIHsgdmFyaWFkaWM6IHRydWUsIG1hcHBlZDogdHJ1ZSB9KVxuICAgICAgXSxcbiAgICAgICh3b3JsZCwgZnJvbSwgeyB0aW1lbG9jaywgdGFyZ2V0LCB2YWx1ZSwgc2lnbmF0dXJlLCBkYXRhLCBldGEgfSkgPT4ge1xuICAgICAgICBjb25zdCBlbmNvZGVkRGF0YSA9IGVuY29kZVBhcmFtZXRlcnMod29ybGQsIHNpZ25hdHVyZS52YWwsIGRhdGEubWFwKGEgPT4gYS52YWwpKTtcbiAgICAgICAgcmV0dXJuIHF1ZXVlVHJhbnNhY3Rpb24od29ybGQsIGZyb20sIHRpbWVsb2NrLCB0YXJnZXQudmFsLCB2YWx1ZSwgc2lnbmF0dXJlLnZhbCwgZW5jb2RlZERhdGEsIGV0YSk7XG4gICAgICB9XG4gICAgKSxcbiAgICBuZXcgQ29tbWFuZDx7XG4gICAgICB0aW1lbG9jazogVGltZWxvY2s7XG4gICAgICB0YXJnZXQ6IEFkZHJlc3NWO1xuICAgICAgdmFsdWU6IE51bWJlclY7XG4gICAgICBldGE6IE51bWJlclY7XG4gICAgICBzaWduYXR1cmU6IFN0cmluZ1Y7XG4gICAgICBkYXRhOiBTdHJpbmdWW107XG4gICAgfT4oXG4gICAgICBgXG4gICAgICAgICMjIyMgQ2FuY2VsVHJhbnNhY3Rpb25cblxuICAgICAgICAqIFwiQ2FuY2VsVHJhbnNhY3Rpb24gdGFyZ2V0OjxBZGRyZXNzPiB2YWx1ZTo8TnVtYmVyPiBldGE6PE51bWJlcj4gc2lnbmF0dXJlOjxTdHJpbmc+IC4uLmZ1bkFyZ3M6PENvcmVWYWx1ZT5cIiAtIENhbmNlbHMgYSB0cmFuc2FjdGlvbiBmcm9tIHRoZSBUaW1lbG9ja1xuICAgICAgICAqIEUuZy4gXCJUaW1lbG9jayBDYW5jZWxUcmFuc2FjdGlvbiBcXFwiMHgwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwXFxcIiAwIDE1NjkyODYwMTQgXFxcInNldERlbGF5KHVpbnQyNTYpXFxcIiA2MDY4MFwiXG4gICAgYCxcbiAgICAgICdDYW5jZWxUcmFuc2FjdGlvbicsXG4gICAgICBbXG4gICAgICAgIG5ldyBBcmcoJ3RpbWVsb2NrJywgZ2V0VGltZWxvY2ssIHsgaW1wbGljaXQ6IHRydWUgfSksXG4gICAgICAgIG5ldyBBcmcoJ3RhcmdldCcsIGdldEFkZHJlc3NWKSxcbiAgICAgICAgbmV3IEFyZygndmFsdWUnLCBnZXROdW1iZXJWKSxcbiAgICAgICAgbmV3IEFyZygnZXRhJywgZ2V0TnVtYmVyViksXG4gICAgICAgIG5ldyBBcmcoJ3NpZ25hdHVyZScsIGdldFN0cmluZ1YpLFxuICAgICAgICBuZXcgQXJnKCdkYXRhJywgZ2V0Q29yZVZhbHVlLCB7IHZhcmlhZGljOiB0cnVlLCBtYXBwZWQ6IHRydWUgfSlcbiAgICAgIF0sXG4gICAgICAod29ybGQsIGZyb20sIHsgdGltZWxvY2ssIHRhcmdldCwgdmFsdWUsIHNpZ25hdHVyZSwgZGF0YSwgZXRhIH0pID0+IHtcbiAgICAgICAgY29uc3QgZW5jb2RlZERhdGEgPSBlbmNvZGVQYXJhbWV0ZXJzKHdvcmxkLCBzaWduYXR1cmUudmFsLCBkYXRhLm1hcChhID0+IGEudmFsKSk7XG4gICAgICAgIHJldHVybiBjYW5jZWxUcmFuc2FjdGlvbih3b3JsZCwgZnJvbSwgdGltZWxvY2ssIHRhcmdldC52YWwsIHZhbHVlLCBzaWduYXR1cmUudmFsLCBlbmNvZGVkRGF0YSwgZXRhKTtcbiAgICAgIH1cbiAgICApLFxuICAgIG5ldyBDb21tYW5kPHtcbiAgICAgIHRpbWVsb2NrOiBUaW1lbG9jaztcbiAgICAgIHRhcmdldDogQWRkcmVzc1Y7XG4gICAgICB2YWx1ZTogTnVtYmVyVjtcbiAgICAgIGV0YTogTnVtYmVyVjtcbiAgICAgIHNpZ25hdHVyZTogU3RyaW5nVjtcbiAgICAgIGRhdGE6IFN0cmluZ1ZbXTtcbiAgICB9PihcbiAgICAgIGBcbiAgICAgICAgIyMjIyBFeGVjdXRlVHJhbnNhY3Rpb25cblxuICAgICAgICAqIFwiRXhlY3V0ZVRyYW5zYWN0aW9uIHRhcmdldDo8QWRkcmVzcz4gdmFsdWU6PE51bWJlcj4gZXRhOjxOdW1iZXI+IHNpZ25hdHVyZTo8U3RyaW5nPiAuLi5mdW5BcmdzOjxDb3JlVmFsdWU+XCIgLSBFeGVjdXRlcyBhIHRyYW5zYWN0aW9uIGZyb20gdGhlIFRpbWVsb2NrXG4gICAgICAgICogRS5nLiBcIlRpbWVsb2NrIEV4ZWN1dGVUcmFuc2FjdGlvbiBcXFwiMHgwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwXFxcIiAwIDE1NjkyODYwMTQgXFxcInNldERlbGF5KHVpbnQyNTYpXFxcIiA2MDY4MFwiXG4gICAgYCxcbiAgICAgICdFeGVjdXRlVHJhbnNhY3Rpb24nLFxuICAgICAgW1xuICAgICAgICBuZXcgQXJnKCd0aW1lbG9jaycsIGdldFRpbWVsb2NrLCB7IGltcGxpY2l0OiB0cnVlIH0pLFxuICAgICAgICBuZXcgQXJnKCd0YXJnZXQnLCBnZXRBZGRyZXNzViksXG4gICAgICAgIG5ldyBBcmcoJ3ZhbHVlJywgZ2V0TnVtYmVyViksXG4gICAgICAgIG5ldyBBcmcoJ2V0YScsIGdldE51bWJlclYpLFxuICAgICAgICBuZXcgQXJnKCdzaWduYXR1cmUnLCBnZXRTdHJpbmdWKSxcbiAgICAgICAgbmV3IEFyZygnZGF0YScsIGdldENvcmVWYWx1ZSwgeyB2YXJpYWRpYzogdHJ1ZSwgbWFwcGVkOiB0cnVlIH0pXG4gICAgICBdLFxuICAgICAgKHdvcmxkLCBmcm9tLCB7IHRpbWVsb2NrLCB0YXJnZXQsIHZhbHVlLCBzaWduYXR1cmUsIGRhdGEsIGV0YSB9KSA9PiB7XG4gICAgICAgIGNvbnN0IGVuY29kZWREYXRhID0gZW5jb2RlUGFyYW1ldGVycyh3b3JsZCwgc2lnbmF0dXJlLnZhbCwgZGF0YS5tYXAoYSA9PiBhLnZhbCkpO1xuICAgICAgICByZXR1cm4gZXhlY3V0ZVRyYW5zYWN0aW9uKHdvcmxkLCBmcm9tLCB0aW1lbG9jaywgdGFyZ2V0LnZhbCwgdmFsdWUsIHNpZ25hdHVyZS52YWwsIGVuY29kZWREYXRhLCBldGEpO1xuICAgICAgfVxuICAgICksXG4gICAgbmV3IFZpZXc8eyB0aW1lbG9jazogVGltZWxvY2s7IGFwaUtleTogU3RyaW5nVjsgY29udHJhY3ROYW1lOiBTdHJpbmdWIH0+KFxuICAgICAgYFxuICAgICAgICAjIyMjIFZlcmlmeVxuXG4gICAgICAgICogXCJWZXJpZnkgYXBpS2V5OjxTdHJpbmc+IGNvbnRyYWN0TmFtZTo8U3RyaW5nPj1UaW1lbG9ja1wiIC0gVmVyaWZpZXMgVGltZWxvY2sgaW4gRXRoZXJzY2FuXG4gICAgICAgICAgKiBFLmcuIFwiVGltZWxvY2sgVmVyaWZ5IFwibXlBcGlLZXlcIlxuICAgICAgYCxcbiAgICAgICdWZXJpZnknLFxuICAgICAgW1xuICAgICAgICBuZXcgQXJnKCd0aW1lbG9jaycsIGdldFRpbWVsb2NrLCB7IGltcGxpY2l0OiB0cnVlIH0pLFxuICAgICAgICBuZXcgQXJnKCdhcGlLZXknLCBnZXRTdHJpbmdWKSxcbiAgICAgICAgbmV3IEFyZygnY29udHJhY3ROYW1lJywgZ2V0U3RyaW5nViwgeyBkZWZhdWx0OiBuZXcgU3RyaW5nVignVGltZWxvY2snKSB9KVxuICAgICAgXSxcbiAgICAgICh3b3JsZCwgeyB0aW1lbG9jaywgYXBpS2V5LCBjb250cmFjdE5hbWUgfSkgPT5cbiAgICAgICAgdmVyaWZ5VGltZWxvY2sod29ybGQsIHRpbWVsb2NrLCBhcGlLZXkudmFsLCBjb250cmFjdE5hbWUudmFsKVxuICAgIClcbiAgXTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHByb2Nlc3NUaW1lbG9ja0V2ZW50KHdvcmxkOiBXb3JsZCwgZXZlbnQ6IEV2ZW50LCBmcm9tOiBzdHJpbmcgfCBudWxsKTogUHJvbWlzZTxXb3JsZD4ge1xuICByZXR1cm4gYXdhaXQgcHJvY2Vzc0NvbW1hbmRFdmVudDxhbnk+KCdUaW1lbG9jaycsIHRpbWVsb2NrQ29tbWFuZHMoKSwgd29ybGQsIGV2ZW50LCBmcm9tKTtcbn1cbiJdfQ==