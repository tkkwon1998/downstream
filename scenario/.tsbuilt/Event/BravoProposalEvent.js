"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.processProposalEvent = exports.proposalCommands = void 0;
const World_1 = require("../World");
const Invokation_1 = require("../Invokation");
const CoreValue_1 = require("../CoreValue");
const Command_1 = require("../Command");
const BravoProposalValue_1 = require("../Value/BravoProposalValue");
function getSupport(support) {
    if (typeof support === "string") {
        if (support === "For" || support === "Against" || support === "Abstain") {
            if (support === "Against")
                return 0;
            else if (support === "For")
                return 1;
            else if (support === "Abstain")
                return 2;
        }
    }
    throw new Error(`Unknown support flag \`${support}\`, expected "For", "Against", or "Abstain"`);
}
function getReason(reason) {
    if (typeof reason[1] === "string") {
        return reason[1];
    }
    else {
        throw new Error(`Reason is not a string ${reason}`);
    }
}
async function describeProposal(world, governor, proposalId) {
    // const proposal = await governor.methods.proposals(proposalId).call();
    return `proposal ${proposalId.toString()}`; // TODO: Cleanup
}
function proposalCommands(governor) {
    return [
        new Command_1.Command(`
        #### VoteWithReason

        * "GovernorBravo <Governor> Proposal <Number> VoteWithReason <For|Against|Abstain> <Reason>" - Votes for, against, or abstain on a given proposal with reason
        * E.g. "GovernorBravo GovernorBravoScenario Proposal LastProposal VoteWithReason For 'must be done'"
    `, "VoteWithReason", [
            new Command_1.Arg("proposalIdent", CoreValue_1.getEventV),
            new Command_1.Arg("support", CoreValue_1.getEventV),
            new Command_1.Arg("reason", CoreValue_1.getEventV),
        ], async (world, from, { proposalIdent, support, reason }) => {
            const proposalId = await BravoProposalValue_1.getProposalId(world, governor, proposalIdent.val);
            const invokation = await Invokation_1.invoke(world, governor.methods.castVoteWithReason(proposalId, getSupport(support.val), getReason(reason.val)), from);
            return World_1.addAction(world, `Cast ${support.val.toString()} vote from ${World_1.describeUser(world, from)} for proposal ${proposalId} with reason ${reason.val.toString()}`, invokation);
        }, { namePos: 1 }),
        new Command_1.Command(`
        #### Vote

        * "GovernorBravo <Governor> Proposal <Number> Vote <For|Against|Abstain> <Reason>" - Votes for, against, or abstain on a given proposal
        * E.g. "GovernorBravo GovernorBravoScenario Proposal LastProposal Vote For"
    `, "Vote", [
            new Command_1.Arg("proposalIdent", CoreValue_1.getEventV),
            new Command_1.Arg("support", CoreValue_1.getEventV)
        ], async (world, from, { proposalIdent, support }) => {
            const proposalId = await BravoProposalValue_1.getProposalId(world, governor, proposalIdent.val);
            const invokation = await Invokation_1.invoke(world, governor.methods.castVote(proposalId, getSupport(support.val)), from);
            return World_1.addAction(world, `Cast ${support.val.toString()} vote from ${World_1.describeUser(world, from)} for proposal ${proposalId}`, invokation);
        }, { namePos: 1 }),
        new Command_1.Command(`
        #### Queue
        * "GovernorBravo <Governor> Queue" - Queues given proposal
        * E.g. "GovernorBravo GovernorBravoScenario Proposal LastProposal Queue"
    `, "Queue", [new Command_1.Arg("proposalIdent", CoreValue_1.getEventV)], async (world, from, { proposalIdent }) => {
            const proposalId = await BravoProposalValue_1.getProposalId(world, governor, proposalIdent.val);
            const invokation = await Invokation_1.invoke(world, governor.methods.queue(proposalId), from);
            return World_1.addAction(world, `Queue proposal ${await describeProposal(world, governor, proposalId)} from ${World_1.describeUser(world, from)}`, invokation);
        }, { namePos: 1 }),
        new Command_1.Command(`
        #### Execute
        * "GovernorBravo <Governor> Execute" - Executes given proposal
        * E.g. "GovernorBravo GovernorBravoScenario Proposal LastProposal Execute"
    `, "Execute", [new Command_1.Arg("proposalIdent", CoreValue_1.getEventV)], async (world, from, { proposalIdent }) => {
            const proposalId = await BravoProposalValue_1.getProposalId(world, governor, proposalIdent.val);
            const invokation = await Invokation_1.invoke(world, governor.methods.execute(proposalId), from);
            return World_1.addAction(world, `Execute proposal ${await describeProposal(world, governor, proposalId)} from ${World_1.describeUser(world, from)}`, invokation);
        }, { namePos: 1 }),
        new Command_1.Command(`
        #### Cancel
        * "Cancel" - cancels given proposal
        * E.g. "GovernorBravo Proposal LastProposal Cancel"
    `, "Cancel", [new Command_1.Arg("proposalIdent", CoreValue_1.getEventV)], async (world, from, { proposalIdent }) => {
            const proposalId = await BravoProposalValue_1.getProposalId(world, governor, proposalIdent.val);
            const invokation = await Invokation_1.invoke(world, governor.methods.cancel(proposalId), from);
            return World_1.addAction(world, `Cancel proposal ${await describeProposal(world, governor, proposalId)} from ${World_1.describeUser(world, from)}`, invokation);
        }, { namePos: 1 }),
    ];
}
exports.proposalCommands = proposalCommands;
async function processProposalEvent(world, governor, event, from) {
    return await Command_1.processCommandEvent("Proposal", proposalCommands(governor), world, event, from);
}
exports.processProposalEvent = processProposalEvent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQnJhdm9Qcm9wb3NhbEV2ZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL0V2ZW50L0JyYXZvUHJvcG9zYWxFdmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxvQ0FBMEQ7QUFFMUQsOENBQXVDO0FBQ3ZDLDRDQUF5QztBQUV6Qyx3Q0FBK0Q7QUFDL0Qsb0VBQTREO0FBRTVELFNBQVMsVUFBVSxDQUFDLE9BQWM7SUFDaEMsSUFBSSxPQUFPLE9BQU8sS0FBSyxRQUFRLEVBQUU7UUFDL0IsSUFBSSxPQUFPLEtBQUssS0FBSyxJQUFJLE9BQU8sS0FBSyxTQUFTLElBQUksT0FBTyxLQUFLLFNBQVMsRUFBRTtZQUN2RSxJQUFJLE9BQU8sS0FBSyxTQUFTO2dCQUFFLE9BQU8sQ0FBQyxDQUFDO2lCQUMvQixJQUFJLE9BQU8sS0FBSyxLQUFLO2dCQUFFLE9BQU8sQ0FBQyxDQUFDO2lCQUNoQyxJQUFJLE9BQU8sS0FBSyxTQUFTO2dCQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQzFDO0tBQ0Y7SUFDRCxNQUFNLElBQUksS0FBSyxDQUNiLDBCQUEwQixPQUFPLDZDQUE2QyxDQUMvRSxDQUFDO0FBQ0osQ0FBQztBQUVELFNBQVMsU0FBUyxDQUFDLE1BQWE7SUFDOUIsSUFBSSxPQUFPLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxRQUFRLEVBQUU7UUFDakMsT0FBTyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDbEI7U0FBTTtRQUNMLE1BQU0sSUFBSSxLQUFLLENBQUMsMEJBQTBCLE1BQU0sRUFBRSxDQUFDLENBQUM7S0FDckQ7QUFDSCxDQUFDO0FBRUQsS0FBSyxVQUFVLGdCQUFnQixDQUM3QixLQUFZLEVBQ1osUUFBdUIsRUFDdkIsVUFBa0I7SUFFbEIsd0VBQXdFO0lBQ3hFLE9BQU8sWUFBWSxVQUFVLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDLGdCQUFnQjtBQUM5RCxDQUFDO0FBRUQsU0FBZ0IsZ0JBQWdC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LE1BQU0sVUFBVSxHQUFHLE1BQU0sbUJBQU0sQ0FDN0IsS0FBSyxFQUNMLFFBQVEsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxFQUNuQyxJQUFJLENBQ0wsQ0FBQztZQUVGLE9BQU8saUJBQVMsQ0FDZCxLQUFLLEVBQ0wsbUJBQW1CLE1BQU0sZ0JBQWdCLENBQ3ZDLEtBQUssRUFDTCxRQUFRLEVBQ1IsVUFBVSxDQUNYLFNBQVMsb0JBQVksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFDckMsVUFBVSxDQUNYLENBQUM7UUFDSixDQUFDLEVBQ0QsRUFBRSxPQUFPLEVBQUUsQ0FBQyxFQUFFLENBQ2Y7S0FDRixDQUFDO0FBQ0osQ0FBQztBQW5MRCw0Q0FtTEM7QUFFTSxLQUFLLFVBQVUsb0JBQW9CLENBQ3hDLEtBQVksRUFDWixRQUF1QixFQUN2QixLQUFZLEVBQ1osSUFBbUI7SUFFbkIsT0FBTyxNQUFNLDZCQUFtQixDQUM5QixVQUFVLEVBQ1YsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLEVBQzFCLEtBQUssRUFDTCxLQUFLLEVBQ0wsSUFBSSxDQUNMLENBQUM7QUFDSixDQUFDO0FBYkQsb0RBYUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudCB9IGZyb20gXCIuLi9FdmVudFwiO1xuaW1wb3J0IHsgYWRkQWN0aW9uLCBkZXNjcmliZVVzZXIsIFdvcmxkIH0gZnJvbSBcIi4uL1dvcmxkXCI7XG5pbXBvcnQgeyBHb3Zlcm5vckJyYXZvIH0gZnJvbSBcIi4uL0NvbnRyYWN0L0dvdmVybm9yQnJhdm9cIjtcbmltcG9ydCB7IGludm9rZSB9IGZyb20gXCIuLi9JbnZva2F0aW9uXCI7XG5pbXBvcnQgeyBnZXRFdmVudFYgfSBmcm9tIFwiLi4vQ29yZVZhbHVlXCI7XG5pbXBvcnQgeyBFdmVudFYgfSBmcm9tIFwiLi4vVmFsdWVcIjtcbmltcG9ydCB7IEFyZywgQ29tbWFuZCwgcHJvY2Vzc0NvbW1hbmRFdmVudCB9IGZyb20gXCIuLi9Db21tYW5kXCI7XG5pbXBvcnQgeyBnZXRQcm9wb3NhbElkIH0gZnJvbSBcIi4uL1ZhbHVlL0JyYXZvUHJvcG9zYWxWYWx1ZVwiO1xuXG5mdW5jdGlvbiBnZXRTdXBwb3J0KHN1cHBvcnQ6IEV2ZW50KTogbnVtYmVyIHtcbiAgaWYgKHR5cGVvZiBzdXBwb3J0ID09PSBcInN0cmluZ1wiKSB7XG4gICAgaWYgKHN1cHBvcnQgPT09IFwiRm9yXCIgfHwgc3VwcG9ydCA9PT0gXCJBZ2FpbnN0XCIgfHwgc3VwcG9ydCA9PT0gXCJBYnN0YWluXCIpIHtcbiAgICAgIGlmIChzdXBwb3J0ID09PSBcIkFnYWluc3RcIikgcmV0dXJuIDA7XG4gICAgICBlbHNlIGlmIChzdXBwb3J0ID09PSBcIkZvclwiKSByZXR1cm4gMTtcbiAgICAgIGVsc2UgaWYgKHN1cHBvcnQgPT09IFwiQWJzdGFpblwiKSByZXR1cm4gMjtcbiAgICB9XG4gIH1cbiAgdGhyb3cgbmV3IEVycm9yKFxuICAgIGBVbmtub3duIHN1cHBvcnQgZmxhZyBcXGAke3N1cHBvcnR9XFxgLCBleHBlY3RlZCBcIkZvclwiLCBcIkFnYWluc3RcIiwgb3IgXCJBYnN0YWluXCJgXG4gICk7XG59XG5cbmZ1bmN0aW9uIGdldFJlYXNvbihyZWFzb246IEV2ZW50KTogc3RyaW5nIHtcbiAgaWYgKHR5cGVvZiByZWFzb25bMV0gPT09IFwic3RyaW5nXCIpIHtcbiAgICByZXR1cm4gcmVhc29uWzFdO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBFcnJvcihgUmVhc29uIGlzIG5vdCBhIHN0cmluZyAke3JlYXNvbn1gKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBkZXNjcmliZVByb3Bvc2FsKFxuICB3b3JsZDogV29ybGQsXG4gIGdvdmVybm9yOiBHb3Zlcm5vckJyYXZvLFxuICBwcm9wb3NhbElkOiBudW1iZXJcbik6IFByb21pc2U8c3RyaW5nPiB7XG4gIC8vIGNvbnN0IHByb3Bvc2FsID0gYXdhaXQgZ292ZXJub3IubWV0aG9kcy5wcm9wb3NhbHMocHJvcG9zYWxJZCkuY2FsbCgpO1xuICByZXR1cm4gYHByb3Bvc2FsICR7cHJvcG9zYWxJZC50b1N0cmluZygpfWA7IC8vIFRPRE86IENsZWFudXBcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHByb3Bvc2FsQ29tbWFuZHMoZ292ZXJub3I6IEdvdmVybm9yQnJhdm8pIHtcbiAgcmV0dXJuIFtcbiAgICBuZXcgQ29tbWFuZDx7IHByb3Bvc2FsSWRlbnQ6IEV2ZW50Vjsgc3VwcG9ydDogRXZlbnRWOyByZWFzb246IEV2ZW50ViB9PihcbiAgICAgIGBcbiAgICAgICAgIyMjIyBWb3RlV2l0aFJlYXNvblxuXG4gICAgICAgICogXCJHb3Zlcm5vckJyYXZvIDxHb3Zlcm5vcj4gUHJvcG9zYWwgPE51bWJlcj4gVm90ZVdpdGhSZWFzb24gPEZvcnxBZ2FpbnN0fEFic3RhaW4+IDxSZWFzb24+XCIgLSBWb3RlcyBmb3IsIGFnYWluc3QsIG9yIGFic3RhaW4gb24gYSBnaXZlbiBwcm9wb3NhbCB3aXRoIHJlYXNvblxuICAgICAgICAqIEUuZy4gXCJHb3Zlcm5vckJyYXZvIEdvdmVybm9yQnJhdm9TY2VuYXJpbyBQcm9wb3NhbCBMYXN0UHJvcG9zYWwgVm90ZVdpdGhSZWFzb24gRm9yICdtdXN0IGJlIGRvbmUnXCJcbiAgICBgLFxuICAgICAgXCJWb3RlV2l0aFJlYXNvblwiLFxuICAgICAgW1xuICAgICAgICBuZXcgQXJnKFwicHJvcG9zYWxJZGVudFwiLCBnZXRFdmVudFYpLFxuICAgICAgICBuZXcgQXJnKFwic3VwcG9ydFwiLCBnZXRFdmVudFYpLFxuICAgICAgICBuZXcgQXJnKFwicmVhc29uXCIsIGdldEV2ZW50ViksXG4gICAgICBdLFxuICAgICAgYXN5bmMgKHdvcmxkLCBmcm9tLCB7IHByb3Bvc2FsSWRlbnQsIHN1cHBvcnQsIHJlYXNvbiB9KSA9PiB7XG4gICAgICAgIGNvbnN0IHByb3Bvc2FsSWQgPSBhd2FpdCBnZXRQcm9wb3NhbElkKFxuICAgICAgICAgIHdvcmxkLFxuICAgICAgICAgIGdvdmVybm9yLFxuICAgICAgICAgIHByb3Bvc2FsSWRlbnQudmFsXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IGludm9rYXRpb24gPSBhd2FpdCBpbnZva2UoXG4gICAgICAgICAgd29ybGQsXG4gICAgICAgICAgZ292ZXJub3IubWV0aG9kcy5jYXN0Vm90ZVdpdGhSZWFzb24oXG4gICAgICAgICAgICBwcm9wb3NhbElkLFxuICAgICAgICAgICAgZ2V0U3VwcG9ydChzdXBwb3J0LnZhbCksXG4gICAgICAgICAgICBnZXRSZWFzb24ocmVhc29uLnZhbClcbiAgICAgICAgICApLFxuICAgICAgICAgIGZyb21cbiAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4gYWRkQWN0aW9uKFxuICAgICAgICAgIHdvcmxkLFxuICAgICAgICAgIGBDYXN0ICR7c3VwcG9ydC52YWwudG9TdHJpbmcoKX0gdm90ZSBmcm9tICR7ZGVzY3JpYmVVc2VyKFxuICAgICAgICAgICAgd29ybGQsXG4gICAgICAgICAgICBmcm9tXG4gICAgICAgICAgKX0gZm9yIHByb3Bvc2FsICR7cHJvcG9zYWxJZH0gd2l0aCByZWFzb24gJHtyZWFzb24udmFsLnRvU3RyaW5nKCl9YCxcbiAgICAgICAgICBpbnZva2F0aW9uXG4gICAgICAgICk7XG4gICAgICB9LFxuICAgICAgeyBuYW1lUG9zOiAxIH1cbiAgICApLFxuXG4gICAgbmV3IENvbW1hbmQ8eyBwcm9wb3NhbElkZW50OiBFdmVudFY7IHN1cHBvcnQ6IEV2ZW50ViB9PihcbiAgICAgIGBcbiAgICAgICAgIyMjIyBWb3RlXG5cbiAgICAgICAgKiBcIkdvdmVybm9yQnJhdm8gPEdvdmVybm9yPiBQcm9wb3NhbCA8TnVtYmVyPiBWb3RlIDxGb3J8QWdhaW5zdHxBYnN0YWluPiA8UmVhc29uPlwiIC0gVm90ZXMgZm9yLCBhZ2FpbnN0LCBvciBhYnN0YWluIG9uIGEgZ2l2ZW4gcHJvcG9zYWxcbiAgICAgICAgKiBFLmcuIFwiR292ZXJub3JCcmF2byBHb3Zlcm5vckJyYXZvU2NlbmFyaW8gUHJvcG9zYWwgTGFzdFByb3Bvc2FsIFZvdGUgRm9yXCJcbiAgICBgLFxuICAgICAgXCJWb3RlXCIsXG4gICAgICBbXG4gICAgICAgIG5ldyBBcmcoXCJwcm9wb3NhbElkZW50XCIsIGdldEV2ZW50ViksXG4gICAgICAgIG5ldyBBcmcoXCJzdXBwb3J0XCIsIGdldEV2ZW50VilcbiAgICAgIF0sXG4gICAgICBhc3luYyAod29ybGQsIGZyb20sIHsgcHJvcG9zYWxJZGVudCwgc3VwcG9ydCB9KSA9PiB7XG4gICAgICAgIGNvbnN0IHByb3Bvc2FsSWQgPSBhd2FpdCBnZXRQcm9wb3NhbElkKFxuICAgICAgICAgIHdvcmxkLFxuICAgICAgICAgIGdvdmVybm9yLFxuICAgICAgICAgIHByb3Bvc2FsSWRlbnQudmFsXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IGludm9rYXRpb24gPSBhd2FpdCBpbnZva2UoXG4gICAgICAgICAgd29ybGQsXG4gICAgICAgICAgZ292ZXJub3IubWV0aG9kcy5jYXN0Vm90ZShcbiAgICAgICAgICAgIHByb3Bvc2FsSWQsXG4gICAgICAgICAgICBnZXRTdXBwb3J0KHN1cHBvcnQudmFsKVxuICAgICAgICAgICksXG4gICAgICAgICAgZnJvbVxuICAgICAgICApO1xuXG4gICAgICAgIHJldHVybiBhZGRBY3Rpb24oXG4gICAgICAgICAgd29ybGQsXG4gICAgICAgICAgYENhc3QgJHtzdXBwb3J0LnZhbC50b1N0cmluZygpfSB2b3RlIGZyb20gJHtkZXNjcmliZVVzZXIoXG4gICAgICAgICAgICB3b3JsZCxcbiAgICAgICAgICAgIGZyb21cbiAgICAgICAgICApfSBmb3IgcHJvcG9zYWwgJHtwcm9wb3NhbElkfWAsXG4gICAgICAgICAgaW52b2thdGlvblxuICAgICAgICApO1xuICAgICAgfSxcbiAgICAgIHsgbmFtZVBvczogMSB9XG4gICAgKSxcblxuICAgIG5ldyBDb21tYW5kPHsgcHJvcG9zYWxJZGVudDogRXZlbnRWIH0+KFxuICAgICAgYFxuICAgICAgICAjIyMjIFF1ZXVlXG4gICAgICAgICogXCJHb3Zlcm5vckJyYXZvIDxHb3Zlcm5vcj4gUXVldWVcIiAtIFF1ZXVlcyBnaXZlbiBwcm9wb3NhbFxuICAgICAgICAqIEUuZy4gXCJHb3Zlcm5vckJyYXZvIEdvdmVybm9yQnJhdm9TY2VuYXJpbyBQcm9wb3NhbCBMYXN0UHJvcG9zYWwgUXVldWVcIlxuICAgIGAsXG4gICAgICBcIlF1ZXVlXCIsXG4gICAgICBbbmV3IEFyZyhcInByb3Bvc2FsSWRlbnRcIiwgZ2V0RXZlbnRWKV0sXG4gICAgICBhc3luYyAod29ybGQsIGZyb20sIHsgcHJvcG9zYWxJZGVudCB9KSA9PiB7XG4gICAgICAgIGNvbnN0IHByb3Bvc2FsSWQgPSBhd2FpdCBnZXRQcm9wb3NhbElkKFxuICAgICAgICAgIHdvcmxkLFxuICAgICAgICAgIGdvdmVybm9yLFxuICAgICAgICAgIHByb3Bvc2FsSWRlbnQudmFsXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IGludm9rYXRpb24gPSBhd2FpdCBpbnZva2UoXG4gICAgICAgICAgd29ybGQsXG4gICAgICAgICAgZ292ZXJub3IubWV0aG9kcy5xdWV1ZShwcm9wb3NhbElkKSxcbiAgICAgICAgICBmcm9tXG4gICAgICAgICk7XG5cbiAgICAgICAgcmV0dXJuIGFkZEFjdGlvbihcbiAgICAgICAgICB3b3JsZCxcbiAgICAgICAgICBgUXVldWUgcHJvcG9zYWwgJHthd2FpdCBkZXNjcmliZVByb3Bvc2FsKFxuICAgICAgICAgICAgd29ybGQsXG4gICAgICAgICAgICBnb3Zlcm5vcixcbiAgICAgICAgICAgIHByb3Bvc2FsSWRcbiAgICAgICAgICApfSBmcm9tICR7ZGVzY3JpYmVVc2VyKHdvcmxkLCBmcm9tKX1gLFxuICAgICAgICAgIGludm9rYXRpb25cbiAgICAgICAgKTtcbiAgICAgIH0sXG4gICAgICB7IG5hbWVQb3M6IDEgfVxuICAgICksXG4gICAgbmV3IENvbW1hbmQ8eyBwcm9wb3NhbElkZW50OiBFdmVudFYgfT4oXG4gICAgICBgXG4gICAgICAgICMjIyMgRXhlY3V0ZVxuICAgICAgICAqIFwiR292ZXJub3JCcmF2byA8R292ZXJub3I+IEV4ZWN1dGVcIiAtIEV4ZWN1dGVzIGdpdmVuIHByb3Bvc2FsXG4gICAgICAgICogRS5nLiBcIkdvdmVybm9yQnJhdm8gR292ZXJub3JCcmF2b1NjZW5hcmlvIFByb3Bvc2FsIExhc3RQcm9wb3NhbCBFeGVjdXRlXCJcbiAgICBgLFxuICAgICAgXCJFeGVjdXRlXCIsXG4gICAgICBbbmV3IEFyZyhcInByb3Bvc2FsSWRlbnRcIiwgZ2V0RXZlbnRWKV0sXG4gICAgICBhc3luYyAod29ybGQsIGZyb20sIHsgcHJvcG9zYWxJZGVudCB9KSA9PiB7XG4gICAgICAgIGNvbnN0IHByb3Bvc2FsSWQgPSBhd2FpdCBnZXRQcm9wb3NhbElkKFxuICAgICAgICAgIHdvcmxkLFxuICAgICAgICAgIGdvdmVybm9yLFxuICAgICAgICAgIHByb3Bvc2FsSWRlbnQudmFsXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IGludm9rYXRpb24gPSBhd2FpdCBpbnZva2UoXG4gICAgICAgICAgd29ybGQsXG4gICAgICAgICAgZ292ZXJub3IubWV0aG9kcy5leGVjdXRlKHByb3Bvc2FsSWQpLFxuICAgICAgICAgIGZyb21cbiAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4gYWRkQWN0aW9uKFxuICAgICAgICAgIHdvcmxkLFxuICAgICAgICAgIGBFeGVjdXRlIHByb3Bvc2FsICR7YXdhaXQgZGVzY3JpYmVQcm9wb3NhbChcbiAgICAgICAgICAgIHdvcmxkLFxuICAgICAgICAgICAgZ292ZXJub3IsXG4gICAgICAgICAgICBwcm9wb3NhbElkXG4gICAgICAgICAgKX0gZnJvbSAke2Rlc2NyaWJlVXNlcih3b3JsZCwgZnJvbSl9YCxcbiAgICAgICAgICBpbnZva2F0aW9uXG4gICAgICAgICk7XG4gICAgICB9LFxuICAgICAgeyBuYW1lUG9zOiAxIH1cbiAgICApLFxuICAgIG5ldyBDb21tYW5kPHsgcHJvcG9zYWxJZGVudDogRXZlbnRWIH0+KFxuICAgICAgYFxuICAgICAgICAjIyMjIENhbmNlbFxuICAgICAgICAqIFwiQ2FuY2VsXCIgLSBjYW5jZWxzIGdpdmVuIHByb3Bvc2FsXG4gICAgICAgICogRS5nLiBcIkdvdmVybm9yQnJhdm8gUHJvcG9zYWwgTGFzdFByb3Bvc2FsIENhbmNlbFwiXG4gICAgYCxcbiAgICAgIFwiQ2FuY2VsXCIsXG4gICAgICBbbmV3IEFyZyhcInByb3Bvc2FsSWRlbnRcIiwgZ2V0RXZlbnRWKV0sXG4gICAgICBhc3luYyAod29ybGQsIGZyb20sIHsgcHJvcG9zYWxJZGVudCB9KSA9PiB7XG4gICAgICAgIGNvbnN0IHByb3Bvc2FsSWQgPSBhd2FpdCBnZXRQcm9wb3NhbElkKFxuICAgICAgICAgIHdvcmxkLFxuICAgICAgICAgIGdvdmVybm9yLFxuICAgICAgICAgIHByb3Bvc2FsSWRlbnQudmFsXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IGludm9rYXRpb24gPSBhd2FpdCBpbnZva2UoXG4gICAgICAgICAgd29ybGQsXG4gICAgICAgICAgZ292ZXJub3IubWV0aG9kcy5jYW5jZWwocHJvcG9zYWxJZCksXG4gICAgICAgICAgZnJvbVxuICAgICAgICApO1xuXG4gICAgICAgIHJldHVybiBhZGRBY3Rpb24oXG4gICAgICAgICAgd29ybGQsXG4gICAgICAgICAgYENhbmNlbCBwcm9wb3NhbCAke2F3YWl0IGRlc2NyaWJlUHJvcG9zYWwoXG4gICAgICAgICAgICB3b3JsZCxcbiAgICAgICAgICAgIGdvdmVybm9yLFxuICAgICAgICAgICAgcHJvcG9zYWxJZFxuICAgICAgICAgICl9IGZyb20gJHtkZXNjcmliZVVzZXIod29ybGQsIGZyb20pfWAsXG4gICAgICAgICAgaW52b2thdGlvblxuICAgICAgICApO1xuICAgICAgfSxcbiAgICAgIHsgbmFtZVBvczogMSB9XG4gICAgKSxcbiAgXTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHByb2Nlc3NQcm9wb3NhbEV2ZW50KFxuICB3b3JsZDogV29ybGQsXG4gIGdvdmVybm9yOiBHb3Zlcm5vckJyYXZvLFxuICBldmVudDogRXZlbnQsXG4gIGZyb206IHN0cmluZyB8IG51bGxcbik6IFByb21pc2U8V29ybGQ+IHtcbiAgcmV0dXJuIGF3YWl0IHByb2Nlc3NDb21tYW5kRXZlbnQ8YW55PihcbiAgICBcIlByb3Bvc2FsXCIsXG4gICAgcHJvcG9zYWxDb21tYW5kcyhnb3Zlcm5vciksXG4gICAgd29ybGQsXG4gICAgZXZlbnQsXG4gICAgZnJvbVxuICApO1xufVxuIl19