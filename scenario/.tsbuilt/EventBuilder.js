"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.buildContractFetcher = exports.buildContractEvent = void 0;
const World_1 = require("./World");
const Command_1 = require("./Command");
const Networks_1 = require("./Networks");
const Contract_1 = require("./Contract");
const ContractLookup_1 = require("./ContractLookup");
const Utils_1 = require("./Utils");
const Invokation_1 = require("./Invokation");
const Value_1 = require("./Value");
const CoreValue_1 = require("./CoreValue");
const typeMappings = () => ({
    address: {
        builder: (x) => new Value_1.AddressV(x),
        getter: CoreValue_1.getAddressV
    },
    'address[]': {
        builder: (x) => new Value_1.ArrayV(x),
        getter: (x) => CoreValue_1.getArrayV(x),
    },
    string: {
        builder: (x) => new Value_1.StringV(x),
        getter: CoreValue_1.getStringV
    },
    uint256: {
        builder: (x) => new Value_1.NumberV(x),
        getter: CoreValue_1.getNumberV
    },
    'uint256[]': {
        builder: (x) => new Value_1.ArrayV(x),
        getter: (x) => CoreValue_1.getArrayV(x),
    },
    'uint32[]': {
        builder: (x) => new Value_1.ArrayV(x),
        getter: (x) => CoreValue_1.getArrayV(x),
    },
    'uint96[]': {
        builder: (x) => new Value_1.ArrayV(x),
        getter: (x) => CoreValue_1.getArrayV(x),
    }
});
function buildArg(contractName, name, input) {
    let { getter } = typeMappings()[input.type] || {};
    if (!getter) {
        throw new Error(`Unknown ABI Input Type: ${input.type} of \`${name}\` in ${contractName}`);
    }
    return new Command_1.Arg(name, getter);
}
function getEventName(s) {
    return s.charAt(0).toUpperCase() + s.slice(1);
}
function getContractObjectFn(contractName, implicit) {
    if (implicit) {
        return async function getContractObject(world) {
            return ContractLookup_1.getWorldContract(world, [['Contracts', contractName]]);
        };
    }
    else {
        return async function getContractObject(world, event) {
            return ContractLookup_1.getWorldContract(world, [['Contracts', Utils_1.mustString(event)]]);
        };
    }
}
function buildContractEvent(contractName, implicit) {
    return async (world) => {
        let contractDeployer = Contract_1.getContract(contractName);
        let abis = await world.saddle.abi(contractName);
        async function build(world, from, params) {
            let constructors = abis.filter(({ type }) => type === 'constructor');
            if (constructors.length === 0) {
                constructors.push({
                    constant: false,
                    inputs: [],
                    outputs: [],
                    payable: true,
                    stateMutability: "payable",
                    type: 'constructor'
                });
            }
            const fetchers = constructors.map((abi) => {
                let nameArg = implicit ? [] : [
                    new Command_1.Arg('name', CoreValue_1.getStringV, { default: new Value_1.StringV(contractName) })
                ];
                let nameArgDesc = implicit ? `` : `name:<String>=${contractName}" `;
                let inputNames = abi.inputs.map((input) => getEventName(input.name));
                let args = abi.inputs.map((input) => buildArg(contractName, input.name, input));
                return new Command_1.Fetcher(`
            #### ${contractName}

            * "${contractName} ${nameArgDesc}${inputNames.join(" ")} - Build ${contractName}
              * E.g. "${contractName} Deploy"
            }
          `, contractName, nameArg.concat(args), async (world, paramValues) => {
                    let name = implicit ? contractName : paramValues['name'].val;
                    let params = args.map((arg) => paramValues[arg.name]); // TODO: This is just a guess
                    let paramsEncoded = params.map((param) => typeof (param['encode']) === 'function' ? param.encode() : param.val);
                    return {
                        invokation: await contractDeployer.deploy(world, from, paramsEncoded),
                        name: name,
                        contract: contractName
                    };
                }, { catchall: true });
            });
            let data = await Command_1.getFetcherValue(`Deploy${contractName}`, fetchers, world, params);
            let invokation = data.invokation;
            delete data.invokation;
            if (invokation.error) {
                throw invokation.error;
            }
            const contract = invokation.value;
            contract.address = contract._address;
            const index = contractName == data.name ? [contractName] : [contractName, data.name];
            world = await Networks_1.storeAndSaveContract(world, contract, data.name, invokation, [
                { index: index, data: data }
            ]);
            return { world, contract, data };
        }
        async function deploy(world, from, params) {
            let { world: nextWorld, contract, data } = await build(world, from, params);
            world = nextWorld;
            world = World_1.addAction(world, `Deployed ${contractName} ${data.contract} to address ${contract._address}`, data.invokation);
            return world;
        }
        function commands() {
            async function buildOutput(world, from, fn, inputs, output) {
                const sendable = (inputs['contract'].methods[fn](...Object.values(inputs).slice(1)));
                let invokation = await Invokation_1.invoke(world, sendable, from);
                world = World_1.addAction(world, `Invokation of ${fn} with inputs ${inputs}`, invokation);
                return world;
            }
            let abiCommands = abis.filter(({ type }) => type === 'function').map((abi) => {
                let eventName = getEventName(abi.name);
                let inputNames = abi.inputs.map((input) => getEventName(input.name));
                let args = [
                    new Command_1.Arg("contract", getContractObjectFn(contractName, implicit), implicit ? { implicit: true } : {})
                ].concat(abi.inputs.map((input) => buildArg(contractName, abi.name, input)));
                return new Command_1.Command(`
            #### ${eventName}

            * "${eventName} ${inputNames.join(" ")}" - Executes \`${abi.name}\` function
          `, eventName, args, (world, from, inputs) => buildOutput(world, from, abi.name, inputs, abi.outputs[0]), { namePos: implicit ? 0 : 1 });
            });
            return [
                ...abiCommands,
                new Command_1.Command(`
            #### ${contractName}

            * "${contractName} Deploy" - Deploy ${contractName}
              * E.g. "Counter Deploy"
          `, "Deploy", [
                    new Command_1.Arg("params", CoreValue_1.getEventV, { variadic: true })
                ], (world, from, { params }) => deploy(world, from, params.val))
            ];
        }
        async function processEvent(world, event, from) {
            return await Command_1.processCommandEvent(contractName, commands(), world, event, from);
        }
        let command = new Command_1.Command(`
        #### ${contractName}

        * "${contractName} ...event" - Runs given ${contractName} event
        * E.g. "${contractName} Deploy"
      `, contractName, [new Command_1.Arg('event', CoreValue_1.getEventV, { variadic: true })], (world, from, { event }) => {
            return processEvent(world, event.val, from);
        }, { subExpressions: commands() });
        return command;
    };
}
exports.buildContractEvent = buildContractEvent;
async function buildContractFetcher(world, contractName, implicit) {
    let abis = await world.saddle.abi(contractName);
    function fetchers() {
        async function buildOutput(world, fn, inputs, output) {
            const callable = (inputs['contract'].methods[fn](...Object.values(inputs).slice(1)));
            let value = await callable.call();
            let { builder } = typeMappings()[output.type] || {};
            if (!builder) {
                throw new Error(`Unknown ABI Output Type: ${output.type} of \`${fn}\` in ${contractName}`);
            }
            return builder(value);
        }
        return abis.filter(({ name }) => !!name).map((abi) => {
            let eventName = getEventName(abi.name);
            let inputNames = abi.inputs.map((input) => getEventName(input.name));
            let args = [
                new Command_1.Arg("contract", getContractObjectFn(contractName, implicit), implicit ? { implicit: true } : {})
            ].concat(abi.inputs.map((input) => buildArg(contractName, abi.name, input)));
            return new Command_1.Fetcher(`
          #### ${eventName}

          * "${eventName} ${inputNames.join(" ")}" - Returns the result of \`${abi.name}\` function
        `, eventName, args, (world, inputs) => buildOutput(world, abi.name, inputs, abi.outputs[0]), { namePos: implicit ? 0 : 1 });
        });
    }
    async function getValue(world, event) {
        return await Command_1.getFetcherValue(contractName, fetchers(), world, event);
    }
    let fetcher = new Command_1.Fetcher(`
      #### ${contractName}

      * "${contractName} ...args" - Returns ${contractName} value
    `, contractName, [new Command_1.Arg('res', getValue, { variadic: true })], async (world, { res }) => res, { subExpressions: fetchers() });
    return fetcher;
}
exports.buildContractFetcher = buildContractFetcher;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRXZlbnRCdWlsZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL0V2ZW50QnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxtQ0FBMkM7QUFHM0MsdUNBQThGO0FBQzlGLHlDQUFrRDtBQUNsRCx5Q0FBbUQ7QUFDbkQscURBQW9EO0FBQ3BELG1DQUFxQztBQUNyQyw2Q0FBMEQ7QUFDMUQsbUNBT2lCO0FBQ2pCLDJDQU1xQjtBQVVyQixNQUFNLFlBQVksR0FBRyxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQzFCLE9BQU8sRUFBRTtRQUNQLE9BQU8sRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxnQkFBUSxDQUFDLENBQUMsQ0FBQztRQUMvQixNQUFNLEVBQUUsdUJBQVc7S0FDcEI7SUFDRCxXQUFXLEVBQUU7UUFDWCxPQUFPLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksY0FBTSxDQUFXLENBQUMsQ0FBQztRQUN2QyxNQUFNLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLHFCQUFTLENBQVcsQ0FBQyxDQUFDO0tBQ3RDO0lBQ0QsTUFBTSxFQUFFO1FBQ04sT0FBTyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLGVBQU8sQ0FBQyxDQUFDLENBQUM7UUFDOUIsTUFBTSxFQUFFLHNCQUFVO0tBQ25CO0lBQ0QsT0FBTyxFQUFFO1FBQ1AsT0FBTyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLGVBQU8sQ0FBQyxDQUFDLENBQUM7UUFDOUIsTUFBTSxFQUFFLHNCQUFVO0tBQ25CO0lBQ0QsV0FBVyxFQUFFO1FBQ1gsT0FBTyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLGNBQU0sQ0FBVSxDQUFDLENBQUM7UUFDdEMsTUFBTSxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxxQkFBUyxDQUFVLENBQUMsQ0FBQztLQUNyQztJQUNE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QyxDQUFDO0lBQ2pGLENBQUM7SUFFRCxJQUFJLE9BQU8sR0FBRyxJQUFJLGlCQUFPLENBQ3ZCO2FBQ1MsWUFBWTs7V0FFZCxZQUFZLHVCQUF1QixZQUFZO0tBQ3JELEVBQ0QsWUFBWSxFQUNaLENBQUMsSUFBSSxhQUFHLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLEVBQzlDLEtBQUssRUFBRSxLQUFLLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLENBQUMsR0FBRyxFQUM3QixFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQUUsRUFBRSxDQUMvQixDQUFBO0lBRUQsT0FBTyxPQUFPLENBQUM7QUFDakIsQ0FBQztBQXJERCxvREFxREMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudCB9IGZyb20gJy4vRXZlbnQnO1xuaW1wb3J0IHsgYWRkQWN0aW9uLCBXb3JsZCB9IGZyb20gJy4vV29ybGQnO1xuaW1wb3J0IHsgR292ZXJub3IgfSBmcm9tICcuL0NvbnRyYWN0L0dvdmVybm9yJztcbmltcG9ydCB7IEludm9rYXRpb24gfSBmcm9tICcuL0ludm9rYXRpb24nO1xuaW1wb3J0IHsgQXJnLCBDb21tYW5kLCBGZXRjaGVyLCBnZXRGZXRjaGVyVmFsdWUsIHByb2Nlc3NDb21tYW5kRXZlbnQsIFZpZXcgfSBmcm9tICcuL0NvbW1hbmQnO1xuaW1wb3J0IHsgc3RvcmVBbmRTYXZlQ29udHJhY3QgfSBmcm9tICcuL05ldHdvcmtzJztcbmltcG9ydCB7IENvbnRyYWN0LCBnZXRDb250cmFjdCB9IGZyb20gJy4vQ29udHJhY3QnO1xuaW1wb3J0IHsgZ2V0V29ybGRDb250cmFjdCB9IGZyb20gJy4vQ29udHJhY3RMb29rdXAnO1xuaW1wb3J0IHsgbXVzdFN0cmluZyB9IGZyb20gJy4vVXRpbHMnO1xuaW1wb3J0IHsgQ2FsbGFibGUsIFNlbmRhYmxlLCBpbnZva2UgfSBmcm9tICcuL0ludm9rYXRpb24nO1xuaW1wb3J0IHtcbiAgQWRkcmVzc1YsXG4gIEFycmF5VixcbiAgRXZlbnRWLFxuICBOdW1iZXJWLFxuICBTdHJpbmdWLFxuICBWYWx1ZVxufSBmcm9tICcuL1ZhbHVlJztcbmltcG9ydCB7XG4gIGdldEFkZHJlc3NWLFxuICBnZXRBcnJheVYsXG4gIGdldEV2ZW50VixcbiAgZ2V0TnVtYmVyVixcbiAgZ2V0U3RyaW5nVixcbn0gZnJvbSAnLi9Db3JlVmFsdWUnO1xuaW1wb3J0IHsgQWJpSXRlbSwgQWJpSW5wdXQgfSBmcm9tICd3ZWIzLXV0aWxzJztcblxuZXhwb3J0IGludGVyZmFjZSBDb250cmFjdERhdGE8VD4ge1xuICBpbnZva2F0aW9uOiBJbnZva2F0aW9uPFQ+O1xuICBuYW1lOiBzdHJpbmc7XG4gIGNvbnRyYWN0OiBzdHJpbmc7XG4gIGFkZHJlc3M/OiBzdHJpbmc7XG59XG5cbmNvbnN0IHR5cGVNYXBwaW5ncyA9ICgpID0+ICh7XG4gIGFkZHJlc3M6IHtcbiAgICBidWlsZGVyOiAoeCkgPT4gbmV3IEFkZHJlc3NWKHgpLFxuICAgIGdldHRlcjogZ2V0QWRkcmVzc1ZcbiAgfSxcbiAgJ2FkZHJlc3NbXSc6IHtcbiAgICBidWlsZGVyOiAoeCkgPT4gbmV3IEFycmF5VjxBZGRyZXNzVj4oeCksXG4gICAgZ2V0dGVyOiAoeCkgPT4gZ2V0QXJyYXlWPEFkZHJlc3NWPih4KSxcbiAgfSxcbiAgc3RyaW5nOiB7XG4gICAgYnVpbGRlcjogKHgpID0+IG5ldyBTdHJpbmdWKHgpLFxuICAgIGdldHRlcjogZ2V0U3RyaW5nVlxuICB9LFxuICB1aW50MjU2OiB7XG4gICAgYnVpbGRlcjogKHgpID0+IG5ldyBOdW1iZXJWKHgpLFxuICAgIGdldHRlcjogZ2V0TnVtYmVyVlxuICB9LFxuICAndWludDI1NltdJzoge1xuICAgIGJ1aWxkZXI6ICh4KSA9PiBuZXcgQXJyYXlWPE51bWJlclY+KHgpLFxuICAgIGdldHRlcjogKHgpID0+IGdldEFycmF5VjxOdW1iZXJWPih4KSxcbiAgfSxcbiAgJ3VpbnQzMltdJzoge1xuICAgIGJ1aWxkZXI6ICh4KSA9PiBuZXcgQXJyYXlWPE51bWJlclY+KHgpLFxuICAgIGdldHRlcjogKHgpID0+IGdldEFycmF5VjxOdW1iZXJWPih4KSxcbiAgfSxcbiAgJ3VpbnQ5NltdJzoge1xuICAgIGJ1aWxkZXI6ICh4KSA9PiBuZXcgQXJyYXlWPE51bWJlclY+KHgpLFxuICAgIGdldHRlcjogKHgpID0+IGdldEFycmF5VjxOdW1iZXJWPih4KSxcbiAgfVxufSk7XG5cbmZ1bmN0aW9uIGJ1aWxkQXJnKGNvbnRyYWN0TmFtZTogc3RyaW5nLCBuYW1lOiBzdHJpbmcsIGlucHV0OiBBYmlJbnB1dCk6IEFyZzxWYWx1ZT4ge1xuICBsZXQgeyBnZXR0ZXIgfSA9IHR5cGVNYXBwaW5ncygpW2lucHV0LnR5cGVdIHx8IHt9O1xuXG4gIGlmICghZ2V0dGVyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIEFCSSBJbnB1dCBUeXBlOiAke2lucHV0LnR5cGV9IG9mIFxcYCR7bmFtZX1cXGAgaW4gJHtjb250cmFjdE5hbWV9YCk7XG4gIH1cblxuICByZXR1cm4gbmV3IEFyZyhuYW1lLCBnZXR0ZXIpO1xufVxuXG5mdW5jdGlvbiBnZXRFdmVudE5hbWUocykge1xuICByZXR1cm4gcy5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHMuc2xpY2UoMSk7XG59XG5cbmZ1bmN0aW9uIGdldENvbnRyYWN0T2JqZWN0Rm4oY29udHJhY3ROYW1lLCBpbXBsaWNpdCkge1xuICBpZiAoaW1wbGljaXQpIHtcbiAgICByZXR1cm4gYXN5bmMgZnVuY3Rpb24gZ2V0Q29udHJhY3RPYmplY3Qod29ybGQ6IFdvcmxkKTogUHJvbWlzZTxDb250cmFjdD4ge1xuICAgICAgcmV0dXJuIGdldFdvcmxkQ29udHJhY3Qod29ybGQsIFtbJ0NvbnRyYWN0cycsIGNvbnRyYWN0TmFtZV1dKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGFzeW5jIGZ1bmN0aW9uIGdldENvbnRyYWN0T2JqZWN0KHdvcmxkOiBXb3JsZCwgZXZlbnQ6IEV2ZW50KTogUHJvbWlzZTxDb250cmFjdD4ge1xuICAgICAgcmV0dXJuIGdldFdvcmxkQ29udHJhY3Qod29ybGQsIFtbJ0NvbnRyYWN0cycsIG11c3RTdHJpbmcoZXZlbnQpXV0pO1xuICAgIH1cbiAgfVxufVxuZXhwb3J0IGZ1bmN0aW9uIGJ1aWxkQ29udHJhY3RFdmVudDxUIGV4dGVuZHMgQ29udHJhY3Q+KGNvbnRyYWN0TmFtZTogc3RyaW5nLCBpbXBsaWNpdCkge1xuXG5cbiAgcmV0dXJuIGFzeW5jICh3b3JsZCkgPT4ge1xuICAgIGxldCBjb250cmFjdERlcGxveWVyID0gZ2V0Q29udHJhY3QoY29udHJhY3ROYW1lKTtcbiAgICBsZXQgYWJpczogQWJpSXRlbVtdID0gYXdhaXQgd29ybGQuc2FkZGxlLmFiaShjb250cmFjdE5hbWUpO1xuXG4gICAgYXN5bmMgZnVuY3Rpb24gYnVpbGQ8VCBleHRlbmRzIENvbnRyYWN0PihcbiAgICAgIHdvcmxkOiBXb3JsZCxcbiAgICAgIGZyb206IHN0cmluZyxcbiAgICAgIHBhcmFtczogRXZlbnRcbiAgICApOiBQcm9taXNlPHsgd29ybGQ6IFdvcmxkOyBjb250cmFjdDogVDsgZGF0YTogQ29udHJhY3REYXRhPFQ+IH0+IHtcbiAgICAgIGxldCBjb25zdHJ1Y3RvcnMgPSBhYmlzLmZpbHRlcigoe3R5cGV9KSA9PiB0eXBlID09PSAnY29uc3RydWN0b3InKTtcbiAgICAgIGlmIChjb25zdHJ1Y3RvcnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGNvbnN0cnVjdG9ycy5wdXNoKHtcbiAgICAgICAgICBjb25zdGFudDogZmFsc2UsXG4gICAgICAgICAgaW5wdXRzOiBbXSxcbiAgICAgICAgICBvdXRwdXRzOiBbXSxcbiAgICAgICAgICBwYXlhYmxlOiB0cnVlLFxuICAgICAgICAgIHN0YXRlTXV0YWJpbGl0eTogXCJwYXlhYmxlXCIsXG4gICAgICAgICAgdHlwZTogJ2NvbnN0cnVjdG9yJ1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZmV0Y2hlcnMgPSBjb25zdHJ1Y3RvcnMubWFwKChhYmk6IGFueSkgPT4ge1xuICAgICAgICBsZXQgbmFtZUFyZyA9IGltcGxpY2l0ID8gW10gOiBbXG4gICAgICAgICAgbmV3IEFyZygnbmFtZScsIGdldFN0cmluZ1YsIHsgZGVmYXVsdDogbmV3IFN0cmluZ1YoY29udHJhY3ROYW1lKSB9KVxuICAgICAgICBdO1xuICAgICAgICBsZXQgbmFtZUFyZ0Rlc2MgPSBpbXBsaWNpdCA/IGBgIDogYG5hbWU6PFN0cmluZz49JHtjb250cmFjdE5hbWV9XCIgYFxuICAgICAgICBsZXQgaW5wdXROYW1lcyA9IGFiaS5pbnB1dHMubWFwKChpbnB1dCkgPT4gZ2V0RXZlbnROYW1lKGlucHV0Lm5hbWUpKTtcbiAgICAgICAgbGV0IGFyZ3MgPSBhYmkuaW5wdXRzLm1hcCgoaW5wdXQpID0+IGJ1aWxkQXJnKGNvbnRyYWN0TmFtZSwgaW5wdXQubmFtZSwgaW5wdXQpKTtcbiAgICAgICAgcmV0dXJuIG5ldyBGZXRjaGVyPG9iamVjdCwgQ29udHJhY3REYXRhPFQ+PihcbiAgICAgICAgICBgXG4gICAgICAgICAgICAjIyMjICR7Y29udHJhY3ROYW1lfVxuXG4gICAgICAgICAgICAqIFwiJHtjb250cmFjdE5hbWV9ICR7bmFtZUFyZ0Rlc2N9JHtpbnB1dE5hbWVzLmpvaW4oXCIgXCIpfSAtIEJ1aWxkICR7Y29udHJhY3ROYW1lfVxuICAgICAgICAgICAgICAqIEUuZy4gXCIke2NvbnRyYWN0TmFtZX0gRGVwbG95XCJcbiAgICAgICAgICAgIH1cbiAgICAgICAgICBgLFxuICAgICAgICAgIGNvbnRyYWN0TmFtZSxcbiAgICAgICAgICBuYW1lQXJnLmNvbmNhdChhcmdzKSxcbiAgICAgICAgICBhc3luYyAod29ybGQsIHBhcmFtVmFsdWVzKSA9PiB7XG4gICAgICAgICAgICBsZXQgbmFtZSA9IGltcGxpY2l0ID8gY29udHJhY3ROYW1lIDogPHN0cmluZz5wYXJhbVZhbHVlc1snbmFtZSddLnZhbDtcbiAgICAgICAgICAgIGxldCBwYXJhbXMgPSBhcmdzLm1hcCgoYXJnKSA9PiBwYXJhbVZhbHVlc1thcmcubmFtZV0pOyAvLyBUT0RPOiBUaGlzIGlzIGp1c3QgYSBndWVzc1xuICAgICAgICAgICAgbGV0IHBhcmFtc0VuY29kZWQgPSBwYXJhbXMubWFwKChwYXJhbSkgPT4gdHlwZW9mKHBhcmFtWydlbmNvZGUnXSkgPT09ICdmdW5jdGlvbicgPyBwYXJhbS5lbmNvZGUoKSA6IHBhcmFtLnZhbCk7XG5cbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgIGludm9rYXRpb246IGF3YWl0IGNvbnRyYWN0RGVwbG95ZXIuZGVwbG95PFQ+KHdvcmxkLCBmcm9tLCBwYXJhbXNFbmNvZGVkKSxcbiAgICAgICAgICAgICAgbmFtZTogbmFtZSxcbiAgICAgICAgICAgICAgY29udHJhY3Q6IGNvbnRyYWN0TmFtZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIHsgY2F0Y2hhbGw6IHRydWUgfVxuICAgICAgICApXG4gICAgICB9KTtcblxuICAgICAgbGV0IGRhdGEgPSBhd2FpdCBnZXRGZXRjaGVyVmFsdWU8YW55LCBDb250cmFjdERhdGE8VD4+KGBEZXBsb3kke2NvbnRyYWN0TmFtZX1gLCBmZXRjaGVycywgd29ybGQsIHBhcmFtcyk7XG4gICAgICBsZXQgaW52b2thdGlvbiA9IGRhdGEuaW52b2thdGlvbjtcbiAgICAgIGRlbGV0ZSBkYXRhLmludm9rYXRpb247XG5cbiAgICAgIGlmIChpbnZva2F0aW9uLmVycm9yKSB7XG4gICAgICAgIHRocm93IGludm9rYXRpb24uZXJyb3I7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNvbnRyYWN0ID0gaW52b2thdGlvbi52YWx1ZSE7XG4gICAgICBjb250cmFjdC5hZGRyZXNzID0gY29udHJhY3QuX2FkZHJlc3M7XG4gICAgICBjb25zdCBpbmRleCA9IGNvbnRyYWN0TmFtZSA9PSBkYXRhLm5hbWUgPyBbY29udHJhY3ROYW1lXSA6IFtjb250cmFjdE5hbWUsIGRhdGEubmFtZV07XG5cbiAgICAgIHdvcmxkID0gYXdhaXQgc3RvcmVBbmRTYXZlQ29udHJhY3QoXG4gICAgICAgIHdvcmxkLFxuICAgICAgICBjb250cmFjdCxcbiAgICAgICAgZGF0YS5uYW1lLFxuICAgICAgICBpbnZva2F0aW9uLFxuICAgICAgICBbXG4gICAgICAgICAgeyBpbmRleDogaW5kZXgsIGRhdGE6IGRhdGEgfVxuICAgICAgICBdXG4gICAgICApO1xuXG4gICAgICByZXR1cm4geyB3b3JsZCwgY29udHJhY3QsIGRhdGEgfTtcbiAgICB9XG5cbiAgICBhc3luYyBmdW5jdGlvbiBkZXBsb3k8VCBleHRlbmRzIENvbnRyYWN0Pih3b3JsZDogV29ybGQsIGZyb206IHN0cmluZywgcGFyYW1zOiBFdmVudCkge1xuICAgICAgbGV0IHsgd29ybGQ6IG5leHRXb3JsZCwgY29udHJhY3QsIGRhdGEgfSA9IGF3YWl0IGJ1aWxkPFQ+KHdvcmxkLCBmcm9tLCBwYXJhbXMpO1xuICAgICAgd29ybGQgPSBuZXh0V29ybGQ7XG5cbiAgICAgIHdvcmxkID0gYWRkQWN0aW9uKFxuICAgICAgICB3b3JsZCxcbiAgICAgICAgYERlcGxveWVkICR7Y29udHJhY3ROYW1lfSAke2RhdGEuY29udHJhY3R9IHRvIGFkZHJlc3MgJHtjb250cmFjdC5fYWRkcmVzc31gLFxuICAgICAgICBkYXRhLmludm9rYXRpb25cbiAgICAgICk7XG5cbiAgICAgIHJldHVybiB3b3JsZDtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBjb21tYW5kczxUIGV4dGVuZHMgQ29udHJhY3Q+KCkge1xuICAgICAgYXN5bmMgZnVuY3Rpb24gYnVpbGRPdXRwdXQod29ybGQ6IFdvcmxkLCBmcm9tOiBzdHJpbmcsIGZuOiBzdHJpbmcsIGlucHV0czogb2JqZWN0LCBvdXRwdXQ6IEFiaUl0ZW0pOiBQcm9taXNlPFdvcmxkPiB7XG4gICAgICAgIGNvbnN0IHNlbmRhYmxlID0gPFNlbmRhYmxlPGFueT4+KGlucHV0c1snY29udHJhY3QnXS5tZXRob2RzW2ZuXSguLi5PYmplY3QudmFsdWVzKGlucHV0cykuc2xpY2UoMSkpKTtcbiAgICAgICAgbGV0IGludm9rYXRpb24gPSBhd2FpdCBpbnZva2Uod29ybGQsIHNlbmRhYmxlLCBmcm9tKTtcblxuICAgICAgICB3b3JsZCA9IGFkZEFjdGlvbihcbiAgICAgICAgICB3b3JsZCxcbiAgICAgICAgICBgSW52b2thdGlvbiBvZiAke2ZufSB3aXRoIGlucHV0cyAke2lucHV0c31gLFxuICAgICAgICAgIGludm9rYXRpb25cbiAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4gd29ybGQ7XG4gICAgICB9XG5cbiAgICAgIGxldCBhYmlDb21tYW5kcyA9IGFiaXMuZmlsdGVyKCh7dHlwZX0pID0+IHR5cGUgPT09ICdmdW5jdGlvbicpLm1hcCgoYWJpOiBhbnkpID0+IHtcbiAgICAgICAgbGV0IGV2ZW50TmFtZSA9IGdldEV2ZW50TmFtZShhYmkubmFtZSk7XG4gICAgICAgIGxldCBpbnB1dE5hbWVzID0gYWJpLmlucHV0cy5tYXAoKGlucHV0KSA9PiBnZXRFdmVudE5hbWUoaW5wdXQubmFtZSkpO1xuICAgICAgICBsZXQgYXJncyA9IFtcbiAgICAgICAgICBuZXcgQXJnKFwiY29udHJhY3RcIiwgZ2V0Q29udHJhY3RPYmplY3RGbihjb250cmFjdE5hbWUsIGltcGxpY2l0KSwgaW1wbGljaXQgPyB7IGltcGxpY2l0OiB0cnVlIH0gOiB7fSlcbiAgICAgICAgXS5jb25jYXQoYWJpLmlucHV0cy5tYXAoKGlucHV0KSA9PiBidWlsZEFyZyhjb250cmFjdE5hbWUsIGFiaS5uYW1lLCBpbnB1dCkpKTtcblxuICAgICAgICByZXR1cm4gbmV3IENvbW1hbmQ8b2JqZWN0PihgXG4gICAgICAgICAgICAjIyMjICR7ZXZlbnROYW1lfVxuXG4gICAgICAgICAgICAqIFwiJHtldmVudE5hbWV9ICR7aW5wdXROYW1lcy5qb2luKFwiIFwiKX1cIiAtIEV4ZWN1dGVzIFxcYCR7YWJpLm5hbWV9XFxgIGZ1bmN0aW9uXG4gICAgICAgICAgYCxcbiAgICAgICAgICBldmVudE5hbWUsXG4gICAgICAgICAgYXJncyxcbiAgICAgICAgICAod29ybGQsIGZyb20sIGlucHV0cykgPT4gYnVpbGRPdXRwdXQod29ybGQsIGZyb20sIGFiaS5uYW1lLCBpbnB1dHMsIGFiaS5vdXRwdXRzWzBdKSxcbiAgICAgICAgICB7IG5hbWVQb3M6IGltcGxpY2l0ID8gMCA6IDEgfVxuICAgICAgICApXG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIFtcbiAgICAgICAgLi4uYWJpQ29tbWFuZHMsXG4gICAgICAgIG5ldyBDb21tYW5kPHsgcGFyYW1zOiBFdmVudFYgfT4oYFxuICAgICAgICAgICAgIyMjIyAke2NvbnRyYWN0TmFtZX1cblxuICAgICAgICAgICAgKiBcIiR7Y29udHJhY3ROYW1lfSBEZXBsb3lcIiAtIERlcGxveSAke2NvbnRyYWN0TmFtZX1cbiAgICAgICAgICAgICAgKiBFLmcuIFwiQ291bnRlciBEZXBsb3lcIlxuICAgICAgICAgIGAsXG4gICAgICAgICAgXCJEZXBsb3lcIixcbiAgICAgICAgICBbXG4gICAgICAgICAgICBuZXcgQXJnKFwicGFyYW1zXCIsIGdldEV2ZW50ViwgeyB2YXJpYWRpYzogdHJ1ZSB9KVxuICAgICAgICAgIF0sXG4gICAgICAgICAgKHdvcmxkLCBmcm9tLCB7IHBhcmFtcyB9KSA9PiBkZXBsb3k8VD4od29ybGQsIGZyb20sIHBhcmFtcy52YWwpXG4gICAgICAgIClcbiAgICAgIF07XG4gICAgfVxuXG4gICAgYXN5bmMgZnVuY3Rpb24gcHJvY2Vzc0V2ZW50KHdvcmxkOiBXb3JsZCwgZXZlbnQ6IEV2ZW50LCBmcm9tOiBzdHJpbmcgfCBudWxsKTogUHJvbWlzZTxXb3JsZD4ge1xuICAgICAgcmV0dXJuIGF3YWl0IHByb2Nlc3NDb21tYW5kRXZlbnQ8YW55Pihjb250cmFjdE5hbWUsIGNvbW1hbmRzKCksIHdvcmxkLCBldmVudCwgZnJvbSk7XG4gICAgfVxuXG4gICAgbGV0IGNvbW1hbmQgPSBuZXcgQ29tbWFuZDx7IGV2ZW50OiBFdmVudFYgfT4oXG4gICAgICBgXG4gICAgICAgICMjIyMgJHtjb250cmFjdE5hbWV9XG5cbiAgICAgICAgKiBcIiR7Y29udHJhY3ROYW1lfSAuLi5ldmVudFwiIC0gUnVucyBnaXZlbiAke2NvbnRyYWN0TmFtZX0gZXZlbnRcbiAgICAgICAgKiBFLmcuIFwiJHtjb250cmFjdE5hbWV9IERlcGxveVwiXG4gICAgICBgLFxuICAgICAgY29udHJhY3ROYW1lLFxuICAgICAgW25ldyBBcmcoJ2V2ZW50JywgZ2V0RXZlbnRWLCB7IHZhcmlhZGljOiB0cnVlIH0pXSxcbiAgICAgICh3b3JsZCwgZnJvbSwgeyBldmVudCB9KSA9PiB7XG4gICAgICAgIHJldHVybiBwcm9jZXNzRXZlbnQod29ybGQsIGV2ZW50LnZhbCwgZnJvbSk7XG4gICAgICB9LFxuICAgICAgeyBzdWJFeHByZXNzaW9uczogY29tbWFuZHMoKSB9XG4gICAgKTtcblxuICAgIHJldHVybiBjb21tYW5kO1xuICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBidWlsZENvbnRyYWN0RmV0Y2hlcjxUIGV4dGVuZHMgQ29udHJhY3Q+KHdvcmxkOiBXb3JsZCwgY29udHJhY3ROYW1lOiBzdHJpbmcsIGltcGxpY2l0OiBib29sZWFuKSB7XG5cbiAgbGV0IGFiaXM6IEFiaUl0ZW1bXSA9IGF3YWl0IHdvcmxkLnNhZGRsZS5hYmkoY29udHJhY3ROYW1lKTtcblxuICBmdW5jdGlvbiBmZXRjaGVycygpIHtcbiAgICBhc3luYyBmdW5jdGlvbiBidWlsZE91dHB1dCh3b3JsZDogV29ybGQsIGZuOiBzdHJpbmcsIGlucHV0czogb2JqZWN0LCBvdXRwdXQ6IEFiaUl0ZW0pOiBQcm9taXNlPFZhbHVlPiB7XG4gICAgICBjb25zdCBjYWxsYWJsZSA9IDxDYWxsYWJsZTxhbnk+PihpbnB1dHNbJ2NvbnRyYWN0J10ubWV0aG9kc1tmbl0oLi4uT2JqZWN0LnZhbHVlcyhpbnB1dHMpLnNsaWNlKDEpKSk7XG4gICAgICBsZXQgdmFsdWUgPSBhd2FpdCBjYWxsYWJsZS5jYWxsKCk7XG4gICAgICBsZXQgeyBidWlsZGVyIH0gPSB0eXBlTWFwcGluZ3MoKVtvdXRwdXQudHlwZV0gfHwge307XG5cbiAgICAgIGlmICghYnVpbGRlcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gQUJJIE91dHB1dCBUeXBlOiAke291dHB1dC50eXBlfSBvZiBcXGAke2ZufVxcYCBpbiAke2NvbnRyYWN0TmFtZX1gKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGJ1aWxkZXIodmFsdWUpO1xuICAgIH1cblxuICAgIHJldHVybiBhYmlzLmZpbHRlcigoe25hbWV9KSA9PiAhIW5hbWUpLm1hcCgoYWJpOiBhbnkpID0+IHtcbiAgICAgIGxldCBldmVudE5hbWUgPSBnZXRFdmVudE5hbWUoYWJpLm5hbWUpO1xuICAgICAgbGV0IGlucHV0TmFtZXMgPSBhYmkuaW5wdXRzLm1hcCgoaW5wdXQpID0+IGdldEV2ZW50TmFtZShpbnB1dC5uYW1lKSk7XG4gICAgICBsZXQgYXJncyA9IFtcbiAgICAgICAgbmV3IEFyZyhcImNvbnRyYWN0XCIsIGdldENvbnRyYWN0T2JqZWN0Rm4oY29udHJhY3ROYW1lLCBpbXBsaWNpdCksIGltcGxpY2l0ID8geyBpbXBsaWNpdDogdHJ1ZSB9IDoge30pXG4gICAgICBdLmNvbmNhdChhYmkuaW5wdXRzLm1hcCgoaW5wdXQpID0+IGJ1aWxkQXJnKGNvbnRyYWN0TmFtZSwgYWJpLm5hbWUsIGlucHV0KSkpO1xuICAgICAgcmV0dXJuIG5ldyBGZXRjaGVyPG9iamVjdCwgVmFsdWU+KGBcbiAgICAgICAgICAjIyMjICR7ZXZlbnROYW1lfVxuXG4gICAgICAgICAgKiBcIiR7ZXZlbnROYW1lfSAke2lucHV0TmFtZXMuam9pbihcIiBcIil9XCIgLSBSZXR1cm5zIHRoZSByZXN1bHQgb2YgXFxgJHthYmkubmFtZX1cXGAgZnVuY3Rpb25cbiAgICAgICAgYCxcbiAgICAgICAgZXZlbnROYW1lLFxuICAgICAgICBhcmdzLFxuICAgICAgICAod29ybGQsIGlucHV0cykgPT4gYnVpbGRPdXRwdXQod29ybGQsIGFiaS5uYW1lLCBpbnB1dHMsIGFiaS5vdXRwdXRzWzBdKSxcbiAgICAgICAgeyBuYW1lUG9zOiBpbXBsaWNpdCA/IDAgOiAxIH1cbiAgICAgIClcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGZ1bmN0aW9uIGdldFZhbHVlKHdvcmxkOiBXb3JsZCwgZXZlbnQ6IEV2ZW50KTogUHJvbWlzZTxWYWx1ZT4ge1xuICAgIHJldHVybiBhd2FpdCBnZXRGZXRjaGVyVmFsdWU8YW55LCBhbnk+KGNvbnRyYWN0TmFtZSwgZmV0Y2hlcnMoKSwgd29ybGQsIGV2ZW50KTtcbiAgfVxuXG4gIGxldCBmZXRjaGVyID0gbmV3IEZldGNoZXI8eyByZXM6IFZhbHVlIH0sIFZhbHVlPihcbiAgICBgXG4gICAgICAjIyMjICR7Y29udHJhY3ROYW1lfVxuXG4gICAgICAqIFwiJHtjb250cmFjdE5hbWV9IC4uLmFyZ3NcIiAtIFJldHVybnMgJHtjb250cmFjdE5hbWV9IHZhbHVlXG4gICAgYCxcbiAgICBjb250cmFjdE5hbWUsXG4gICAgW25ldyBBcmcoJ3JlcycsIGdldFZhbHVlLCB7IHZhcmlhZGljOiB0cnVlIH0pXSxcbiAgICBhc3luYyAod29ybGQsIHsgcmVzIH0pID0+IHJlcyxcbiAgICB7IHN1YkV4cHJlc3Npb25zOiBmZXRjaGVycygpIH1cbiAgKVxuXG4gIHJldHVybiBmZXRjaGVyO1xufVxuIl19